<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>NSE Screener</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: #0d1117; color: #c9d1d9;
    font-family: 'Segoe UI', system-ui, sans-serif; font-size: 13px;
    height: 100vh; display: flex; flex-direction: column; overflow: hidden;
  }

  /* â”€â”€ TOP BAR â”€â”€ */
  #topbar {
    display: flex; align-items: center; gap: 10px;
    padding: 8px 14px; background: #161b22;
    border-bottom: 1px solid #21262d; flex-shrink: 0; flex-wrap: wrap;
  }
  #topbar h1 { font-size: 15px; font-weight: 700; color: #58a6ff; white-space: nowrap; }

  /* â”€â”€ TABS â”€â”€ */
  #tab-bar {
    display: flex;
    background: #161b22; border-bottom: 1px solid #21262d; flex-shrink: 0;
  }
  .tab-btn {
    padding: 8px 22px; cursor: pointer; font-size: 13px; font-weight: 600;
    color: #8b949e; border: none; background: transparent;
    border-bottom: 3px solid transparent; transition: all .15s;
  }
  .tab-btn:hover { color: #c9d1d9; }
  .tab-btn.active { color: #58a6ff; border-bottom-color: #58a6ff; }

  /* â”€â”€ TAB PANELS â”€â”€ */
  .tab-panel { display: none; flex: 1; overflow: hidden; min-height: 0; }
  .tab-panel.active { display: flex; }

  /* â”€â”€ TICKER DROPDOWN â”€â”€ */
  .ticker-wrap { position: relative; width: 210px; flex-shrink: 0; }
  #ticker-search {
    width: 100%; padding: 5px 28px 5px 10px;
    background: #0d1117; border: 1px solid #30363d; border-radius: 6px;
    color: #c9d1d9; font-size: 13px; outline: none; cursor: pointer;
  }
  #ticker-search:focus { border-color: #58a6ff; }
  .ticker-arrow { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: #8b949e; pointer-events: none; font-size: 10px; }
  #ticker-dropdown {
    position: absolute; top: calc(100% + 4px); left: 0; right: 0;
    background: #161b22; border: 1px solid #30363d; border-radius: 6px;
    max-height: 280px; overflow-y: auto; z-index: 999; display: none;
    box-shadow: 0 8px 24px rgba(0,0,0,.6);
  }
  #ticker-dropdown.open { display: block; }
  #dd-search-input {
    width: 100%; padding: 6px 10px;
    background: #0d1117; border: none; border-bottom: 1px solid #30363d;
    color: #c9d1d9; font-size: 12px; outline: none;
  }
  .dd-item { padding: 6px 12px; cursor: pointer; font-size: 12px; color: #c9d1d9; white-space: nowrap; }
  .dd-item:hover, .dd-item.highlighted { background: #1f6feb; color: #fff; }

  select {
    padding: 5px 8px; background: #0d1117; border: 1px solid #30363d;
    border-radius: 6px; color: #c9d1d9; font-size: 13px; outline: none; cursor: pointer;
  }
  select:focus { border-color: #58a6ff; }

  .btn {
    padding: 5px 14px; border-radius: 6px; border: none;
    font-size: 13px; font-weight: 600; cursor: pointer; transition: opacity .15s; white-space: nowrap;
  }
  .btn:hover { opacity: .85; }
  .btn-blue  { background: #1f6feb; color: #fff; }
  .btn-gray  { background: #21262d; color: #c9d1d9; }
  .btn-green { background: #1a7a3a; color: #fff; }

  #countdown {
    font-size: 11px; color: #8b949e; padding: 3px 9px;
    border: 1px solid #30363d; border-radius: 12px;
    background: #0d1117; min-width: 72px; text-align: center; white-space: nowrap;
  }
  #countdown.ticking { color: #58a6ff; border-color: #1f6feb; }
  #status { margin-left: auto; font-size: 12px; color: #8b949e; white-space: nowrap; }

  /* â”€â”€ SIDEBAR â”€â”€ */
  #sidebar {
    width: 220px; min-width: 220px; background: #161b22;
    border-right: 1px solid #21262d; overflow-y: auto;
    padding: 10px 8px; display: flex; flex-direction: column; gap: 10px;
    flex-shrink: 0;
  }
  .section-title {
    font-size: 10px; font-weight: 700; letter-spacing: .08em;
    text-transform: uppercase; color: #8b949e;
    padding: 4px 4px 2px; border-bottom: 1px solid #21262d; margin-bottom: 2px;
  }
  .metric-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 3px 4px; border-radius: 4px;
  }
  .metric-row:hover { background: #1c2128; }
  .metric-label { color: #8b949e; font-size: 12px; }
  .metric-value { font-size: 12px; font-weight: 600; color: #c9d1d9; text-align: right; }

  .val-up     { color: #26a641 !important; }
  .val-dn     { color: #f85149 !important; }
  .val-gold   { color: #ffa657 !important; }
  .val-blue   { color: #58a6ff !important; }
  .val-purple { color: #d2a8ff !important; }

  .badge { display: inline-block; padding: 1px 7px; border-radius: 10px; font-size: 11px; font-weight: 700; }
  .badge-green  { background: #1a3a1a; color: #26a641; border: 1px solid #26a641; }
  .badge-red    { background: #3a1a1a; color: #f85149; border: 1px solid #f85149; }
  .badge-gray   { background: #1c2128; color: #8b949e; border: 1px solid #30363d; }
  .badge-gold   { background: #3a2a00; color: #ffa657; border: 1px solid #ffa657; }
  .badge-blue   { background: #0c2340; color: #58a6ff; border: 1px solid #58a6ff; }
  .badge-purple { background: #2a1a40; color: #d2a8ff; border: 1px solid #d2a8ff; }

  /* â”€â”€ CHART AREA â”€â”€ */
  #chart-area {
    flex: 1; overflow: hidden; display: flex;
    flex-direction: column; align-items: center; justify-content: center;
    background: #0d1117; position: relative;
  }
  #chart-img { max-width: 100%; max-height: 100%; object-fit: contain; display: none; }
  #placeholder { display: flex; flex-direction: column; align-items: center; gap: 12px; color: #8b949e; }
  #placeholder svg { opacity: .3; }
  #placeholder p { font-size: 14px; }
  #loading-overlay {
    position: absolute; inset: 0; background: rgba(13,17,23,.75);
    display: none; align-items: center; justify-content: center;
    flex-direction: column; gap: 12px; z-index: 10;
  }
  .spinner { width: 36px; height: 36px; border: 3px solid #21262d; border-top-color: #58a6ff; border-radius: 50%; animation: spin .7s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  #loading-overlay p { color: #8b949e; font-size: 13px; }

  /* â”€â”€ SCANNER TAB â”€â”€ */
  #scanner-panel { flex-direction: column; background: #0d1117; }
  #scanner-toolbar {
    display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
    padding: 10px 16px; background: #161b22; border-bottom: 1px solid #21262d; flex-shrink: 0;
  }
  #scanner-content {
    flex: 1; overflow-y: auto; padding: 16px;
    display: grid; grid-template-columns: 1fr 1fr; gap: 16px; min-height: 0;
  }
  .scan-table-wrap { background: #161b22; border: 1px solid #21262d; border-radius: 8px; overflow: hidden; }
  .scan-table-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 14px; border-bottom: 1px solid #21262d;
  }
  .scan-table-title { font-size: 13px; font-weight: 700; }
  .scan-table-title.buy  { color: #26a641; }
  .scan-table-title.sell { color: #f85149; }
  .scan-badge { font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
  .scan-badge.buy  { background: #1a3a1a; color: #26a641; }
  .scan-badge.sell { background: #3a1a1a; color: #f85149; }
  table.scan-tbl { width: 100%; border-collapse: collapse; }
  table.scan-tbl th {
    text-align: left; padding: 7px 10px; font-size: 10px; font-weight: 700;
    letter-spacing: .06em; text-transform: uppercase; color: #8b949e;
    background: #0d1117; border-bottom: 1px solid #21262d; white-space: nowrap;
  }
  table.scan-tbl td { padding: 7px 10px; font-size: 12px; border-bottom: 1px solid #161b22; white-space: nowrap; }
  table.scan-tbl tr:last-child td { border-bottom: none; }
  table.scan-tbl tr:hover td { background: #1c2128; cursor: pointer; }
  .score-bar { display: inline-block; height: 6px; border-radius: 3px; vertical-align: middle; margin-left: 6px; }
  .score-bar.buy  { background: #26a641; }
  .score-bar.sell { background: #f85149; }
  #scan-status { padding: 6px 16px; font-size: 11px; color: #8b949e; background: #161b22; border-top: 1px solid #21262d; flex-shrink: 0; }
  #scan-progress-wrap { width: 260px; height: 6px; background: #21262d; border-radius: 3px; overflow: hidden; }
  #scan-progress-bar { height: 100%; width: 0%; background: #1f6feb; transition: width .2s; }

  /* â”€â”€ REPLAY TAB â”€â”€ */
  #replay-panel { flex-direction: column; background: #0d1117; }

  #replay-toolbar {
    display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
    padding: 8px 14px; background: #161b22; border-bottom: 1px solid #21262d;
    flex-shrink: 0;
  }

  .rpl-btn {
    padding: 5px 13px; border-radius: 6px; border: none;
    font-size: 13px; font-weight: 700; cursor: pointer; transition: all .15s;
    white-space: nowrap;
  }
  .rpl-btn:disabled { opacity: .3; cursor: not-allowed; }
  #rpl-load-btn  { background: #1f6feb; color: #fff; }
  #rpl-play-btn  { background: #1a7a3a; color: #fff; min-width: 84px; }
  #rpl-stop-btn  { background: #6e2323; color: #fff; }
  #rpl-reset-btn { background: #21262d; color: #c9d1d9; }

  #rpl-speed-sel { min-width: 100px; }

  #rpl-time-label { font-size: 14px; font-weight: 700; color: #ffd700; min-width: 54px; text-align: center; }
  #rpl-candle-label { font-size: 11px; color: #8b949e; white-space: nowrap; }

  #rpl-progress-wrap {
    flex: 1; min-width: 80px; height: 8px; background: #21262d; border-radius: 4px;
    overflow: hidden; cursor: pointer; position: relative;
  }
  #rpl-progress-bar { height: 100%; width: 0%; background: #1f6feb; pointer-events: none; }

  #replay-body {
    flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; position: relative;
  }
  #rpl-canvas { display: block; width: 100%; height: 100%; }

  #rpl-info-bar {
    position: absolute; top: 6px; left: 68px;
    display: flex; gap: 12px; pointer-events: none; font-size: 11px;
  }

  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 3px; }
</style>
</head>
<body>

<!-- TOP BAR -->
<div id="topbar">
  <h1>ğŸ“ˆ NSE Screener</h1>
  <div class="ticker-wrap" id="ticker-wrap">
    <input id="ticker-search" type="text" placeholder="Search symbolâ€¦" autocomplete="off" value="RELIANCE.NS"/>
    <span class="ticker-arrow">â–¼</span>
    <div id="ticker-dropdown">
      <input id="dd-search-input" type="text" placeholder="Filterâ€¦" autocomplete="off"/>
      <div id="dd-list"></div>
    </div>
  </div>
  <select id="range-sel">
    <option value="1d" selected>1 Day</option>
    <option value="5d">5 Days</option>
    <option value="1mo">1 Month</option>
  </select>
  <select id="interval-sel">
    <option value="1m" selected>1 min</option>
    <option value="5m">5 min</option>
    <option value="15m">15 min</option>
  </select>
  <select id="min-vol-sel" title="Min Volume threshold">
    <option value="5000000">Vol â‰¥ 5M</option>
    <option value="6000000" selected>Vol â‰¥ 6M</option>
    <option value="7000000">Vol â‰¥ 7M</option>
    <option value="8000000">Vol â‰¥ 8M</option>
    <option value="9000000">Vol â‰¥ 9M</option>
    <option value="10000000">Vol â‰¥ 10M</option>
  </select>
  <button class="btn btn-blue" id="btn-load" onclick="loadAll()">Load</button>
  <button class="btn btn-gray" onclick="loadChart()">Chart Only</button>
  <span id="countdown">â± 60s</span>
  <span id="status">â€”</span>
</div>

<!-- TAB BAR -->
<div id="tab-bar">
  <button class="tab-btn active" data-tab="chart">ğŸ“Š Chart</button>
  <button class="tab-btn"       data-tab="scanner">ğŸ” Scanner</button>
  <button class="tab-btn"       data-tab="replay">â–¶ Replay</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CHART TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="chart-panel" class="tab-panel active">
  <div id="sidebar">
    <div>
      <div class="section-title">Price &amp; VWAP</div>
      <div class="metric-row"><span class="metric-label">Close</span><span class="metric-value" id="m-close">â€”</span></div>
      <div class="metric-row"><span class="metric-label">VWAP</span><span class="metric-value" id="m-vwap">â€”</span></div>
      <div class="metric-row"><span class="metric-label">VWAP Dev %</span><span class="metric-value" id="m-vwap-dev">â€”</span></div>
      <div class="metric-row"><span class="metric-label">Gravity (CoG)</span><span class="metric-value val-purple" id="m-gravity">â€”</span></div>
    </div>
    <div>
      <div class="section-title">ORB Levels</div>
      <div class="metric-row"><span class="metric-label">ORB 0% (High)</span><span class="metric-value val-up" id="m-fib0">â€”</span></div>
      <div class="metric-row"><span class="metric-label">ORB 50% (Mid)</span><span class="metric-value val-blue" id="m-fib50">â€”</span></div>
      <div class="metric-row"><span class="metric-label">ORB 100% (Low)</span><span class="metric-value val-dn" id="m-fib100">â€”</span></div>
    </div>
    <div>
      <div class="section-title">Daily Stats</div>
      <div class="metric-row"><span class="metric-label">Higher Highs</span><span class="metric-value val-up" id="m-hh">â€”</span></div>
      <div class="metric-row"><span class="metric-label">Lower Lows</span><span class="metric-value val-dn" id="m-ll">â€”</span></div>
      <div class="metric-row"><span class="metric-label">H-L Range</span><span class="metric-value" id="m-hl">â€”</span></div>
      <div class="metric-row"><span class="metric-label">Cum. Volume</span><span class="metric-value val-gold" id="m-vol">â€”</span></div>
    </div>
    <div>
      <div class="section-title">Zone Bar Counts</div>
      <div class="metric-row"><span class="metric-label">Above L1</span><span class="metric-value val-up" id="m-z1">â€”</span></div>
      <div class="metric-row"><span class="metric-label">L1 â†’ L2</span><span class="metric-value" id="m-z2">â€”</span></div>
      <div class="metric-row"><span class="metric-label">L2 â†’ L3</span><span class="metric-value" id="m-z3">â€”</span></div>
      <div class="metric-row"><span class="metric-label">Below L3</span><span class="metric-value val-dn" id="m-z4">â€”</span></div>
    </div>
    <div>
      <div class="section-title">Donchian Trend</div>
      <div class="metric-row"><span class="metric-label">Main Trend</span><span class="metric-value" id="m-don">â€”</span></div>
      <div class="metric-row"><span class="metric-label">All Green</span><span class="metric-value" id="m-allgreen">â€”</span></div>
      <div class="metric-row"><span class="metric-label">All Red</span><span class="metric-value" id="m-allred">â€”</span></div>
    </div>
    <div>
      <div class="section-title">Signals</div>
      <div class="metric-row"><span class="metric-label">Major Fall</span><span class="metric-value" id="m-majfall">â€”</span></div>
      <div class="metric-row"><span class="metric-label">Basic Rise</span><span class="metric-value" id="m-brise">â€”</span></div>
      <div class="metric-row"><span class="metric-label">Confirmed Rise</span><span class="metric-value" id="m-crise">â€”</span></div>
      <div class="metric-row"><span class="metric-label">Explosive Rise</span><span class="metric-value" id="m-erise">â€”</span></div>
      <div class="metric-row"><span class="metric-label">Parabolic Rise</span><span class="metric-value" id="m-prise">â€”</span></div>
      <div class="metric-row"><span class="metric-label">Escape Velocity</span><span class="metric-value" id="m-escape">â€”</span></div>
      <div class="metric-row"><span class="metric-label">Crash Risk</span><span class="metric-value" id="m-crash">â€”</span></div>
      <div class="metric-row"><span class="metric-label">G â†’ R Flip</span><span class="metric-value" id="m-g2r">â€”</span></div>
      <div class="metric-row"><span class="metric-label">R â†’ G Flip</span><span class="metric-value" id="m-r2g">â€”</span></div>
    </div>
    <div style="padding:4px;color:#8b949e;font-size:11px;" id="m-datetime">â€”</div>
  </div>

  <div id="chart-area">
    <div id="loading-overlay">
      <div class="spinner"></div>
      <p id="loading-msg">Loadingâ€¦</p>
    </div>
    <div id="placeholder">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#58a6ff" stroke-width="1.5">
        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
      </svg>
      <p>Select a symbol and press <strong>Load</strong></p>
    </div>
    <img id="chart-img" alt="Chart"/>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCANNER TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="scanner-panel" class="tab-panel">
  <div id="scanner-toolbar">
    <select id="scan-interval-sel">
      <option value="1m" selected>1 min</option>
      <option value="5m">5 min</option>
      <option value="15m">15 min</option>
    </select>
    <select id="scan-topn-sel">
      <option value="5">Top 5</option>
      <option value="10" selected>Top 10</option>
      <option value="15">Top 15</option>
      <option value="20">Top 20</option>
    </select>
    <button class="btn btn-green" onclick="runScanner()">â–¶ Run Scanner</button>
    <div id="scan-progress-wrap" style="display:none"><div id="scan-progress-bar"></div></div>
    <span id="scan-status-inline" style="font-size:12px;color:#8b949e;">Scan all 93 symbols to find top Buy &amp; Sell setups</span>
  </div>

  <div id="scanner-content">
    <div class="scan-table-wrap">
      <div class="scan-table-header">
        <span class="scan-table-title buy">ğŸŸ¢ Top Buy Setups</span>
        <span class="scan-badge buy" id="buy-count">â€”</span>
      </div>
      <table class="scan-tbl">
        <thead><tr><th>#</th><th>Symbol</th><th>Close</th><th>VWAP Dev%</th><th>Volume</th><th>Signals</th><th>Signal Time</th><th>Score</th></tr></thead>
        <tbody id="buy-tbody"><tr><td colspan="8" style="text-align:center;color:#8b949e;padding:24px">Press Run Scanner</td></tr></tbody>
      </table>
    </div>
    <div class="scan-table-wrap">
      <div class="scan-table-header">
        <span class="scan-table-title sell">ğŸ”´ Top Sell Setups</span>
        <span class="scan-badge sell" id="sell-count">â€”</span>
      </div>
      <table class="scan-tbl">
        <thead><tr><th>#</th><th>Symbol</th><th>Close</th><th>VWAP Dev%</th><th>Volume</th><th>Signals</th><th>Signal Time</th><th>Score</th></tr></thead>
        <tbody id="sell-tbody"><tr><td colspan="8" style="text-align:center;color:#8b949e;padding:24px">Press Run Scanner</td></tr></tbody>
      </table>
    </div>
  </div>
  <div id="scan-status">Ready â€” press Run Scanner to begin</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• REPLAY TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="replay-panel" class="tab-panel">

  <div id="replay-toolbar">
    <button class="rpl-btn" id="rpl-load-btn"  onclick="rplLoad()">ğŸ“¥ Load Data</button>
    <button class="rpl-btn" id="rpl-play-btn"  onclick="rplPlayPause()" disabled>â–¶ Play</button>
    <button class="rpl-btn" id="rpl-stop-btn"  onclick="rplStop()"      disabled>â¹ Stop</button>
    <button class="rpl-btn" id="rpl-reset-btn" onclick="rplReset()"     disabled>â® Reset</button>
    <label style="font-size:12px;color:#8b949e;">Speed</label>
    <select id="rpl-speed-sel">
      <option value="800">0.5Ã—  slow</option>
      <option value="400" selected>1Ã—  normal</option>
      <option value="200">2Ã—  fast</option>
      <option value="80">5Ã—  faster</option>
      <option value="30">10Ã— ultra</option>
      <option value="5">50Ã— turbo</option>
    </select>
    <span id="rpl-time-label">--:--</span>
    <div id="rpl-progress-wrap" title="Click to seek">
      <div id="rpl-progress-bar"></div>
    </div>
    <span id="rpl-candle-label">0 / 0</span>
  </div>

  <div id="replay-body">
    <canvas id="rpl-canvas"></canvas>
    <div id="rpl-info-bar">
      <span id="rpl-ohlcv" style="color:#c9d1d9;font-size:11px;"></span>
    </div>
  </div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STOCK SYMBOLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SYMBOLS = [
  "ATGL.NS","NYKAA.NS","DMART.NS","BANKBARODA.NS","PGHH.NS","LTIM.NS",
  "HDFCAMC.NS","BANDHANBNK.NS","VEDL.NS","ADANIGREEN.NS","AMBUJACEM.NS",
  "PIDILITIND.NS","ICICIGI.NS","ICICIPRULI.NS","INDIGO.NS","GAIL.NS",
  "IOC.NS","MOTHERSON.NS","GLAND.NS","BAJAJHLDNG.NS","GODREJCP.NS",
  "DLF.NS","MARICO.NS","NAUKRI.NS","ACC.NS","HAVELLS.NS","HAL.NS",
  "MPHASIS.NS","LICI.NS","TORNTPHARM.NS","BEL.NS","PIIND.NS","IRCTC.NS",
  "COLPAL.NS","INDUSTOWER.NS","SBICARD.NS","BIOCON.NS","BERGEPAINT.NS",
  "TATAPOWER.NS","SIEMENS.NS","BOSCHLTD.NS","CHOLAFIN.NS","SRF.NS",
  "DABUR.NS","PAYTM.NS","MUTHOOTFIN.NS","BHARTIARTL.NS","EICHERMOT.NS",
  "SBIN.NS","AXISBANK.NS","TATASTEEL.NS","SBILIFE.NS","ADANIPORTS.NS",
  "HINDALCO.NS","JSWSTEEL.NS","ONGC.NS","ICICIBANK.NS","BPCL.NS",
  "INDUSINDBK.NS","HCLTECH.NS","SUNPHARMA.NS","WIPRO.NS","HEROMOTOCO.NS",
  "M&M.NS","INFY.NS","BAJFINANCE.NS","ADANIENT.NS","GRASIM.NS","TCS.NS",
  "HDFCLIFE.NS","ITC.NS","MARUTI.NS","UPL.NS","DRREDDY.NS","NTPC.NS",
  "RELIANCE.NS","CIPLA.NS","KOTAKBANK.NS","BAJAJFINSV.NS","HINDUNILVR.NS",
  "ASIANPAINT.NS","TECHM.NS","NESTLEIND.NS","POWERGRID.NS","LT.NS",
  "BAJAJ-AUTO.NS","BRITANNIA.NS","TATACONSUM.NS","COALINDIA.NS",
  "ULTRACEMCO.NS","DIVISLAB.NS","TITAN.NS","APOLLOHOSP.NS"
].sort();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const $ = id => document.getElementById(id);
function fmt(v, d=2){ return (v==null)?'â€”':Number(v).toFixed(d); }
function badge(on, tl, fl, tc, fc){ return `<span class="badge ${on?tc:fc}">${on?tl:fl}</span>`; }
function donBadge(v){
  if(v===1)  return `<span class="badge badge-green">BULL â–²</span>`;
  if(v===-1) return `<span class="badge badge-red">BEAR â–¼</span>`;
  return `<span class="badge badge-gray">FLAT â€”</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.tab === name);
  });
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  const panel = document.getElementById(name + '-panel');
  if (panel) {
    panel.classList.add('active');
    if (name === 'replay') {
      // Double rAF: wait until panel is fully painted and has real pixel dimensions
      requestAnimationFrame(() => requestAnimationFrame(() => {
        RPL.resize();
        RPL.draw();
      }));
    }
  }
}

document.querySelectorAll('.tab-btn').forEach(b => {
  b.addEventListener('click', () => switchTab(b.dataset.tab));
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TICKER DROPDOWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selectedTicker = 'RELIANCE.NS';

function buildList(filter='') {
  const list = $('dd-list'); list.innerHTML = '';
  const q = filter.toUpperCase();
  SYMBOLS.filter(s => s.includes(q)).forEach(sym => {
    const d = document.createElement('div');
    d.className = 'dd-item' + (sym===selectedTicker?' highlighted':'');
    d.textContent = sym;
    d.addEventListener('mousedown', () => selectTicker(sym));
    list.appendChild(d);
  });
}
function selectTicker(sym){ selectedTicker=sym; $('ticker-search').value=sym; closeDD(); }
function openDD(){ $('dd-search-input').value=''; buildList(''); $('ticker-dropdown').classList.add('open'); $('dd-search-input').focus(); }
function closeDD(){ $('ticker-dropdown').classList.remove('open'); }

$('ticker-search').addEventListener('focus', openDD);
$('ticker-search').addEventListener('input', function(){ selectedTicker=this.value.toUpperCase(); buildList(this.value); $('ticker-dropdown').classList.add('open'); });
$('dd-search-input').addEventListener('input', function(){ buildList(this.value); });
document.addEventListener('mousedown', e => { if(!$('ticker-wrap').contains(e.target)) closeDD(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COUNTDOWN AUTO-REFRESH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const REFRESH_SECS = 60;
let countdown = REFRESH_SECS;
setInterval(() => {
  $('countdown').textContent = `â± ${countdown}s`;
  $('countdown').classList.toggle('ticking', countdown<=10);
  if (--countdown < 0) {
    countdown = REFRESH_SECS;
    if ($('chart-img').style.display !== 'none') loadAll(true);
  }
}, 1000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHART TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStatus(msg, col='#8b949e'){ $('status').textContent=msg; $('status').style.color=col; }
function showLoading(msg='Loadingâ€¦'){ $('loading-msg').textContent=msg; $('loading-overlay').style.display='flex'; }
function hideLoading(){ $('loading-overlay').style.display='none'; }

function getTicker()  { return selectedTicker || 'RELIANCE.NS'; }
function getRange()   { return $('range-sel').value; }
function getInterval(){ return $('interval-sel').value; }
function getMinVol()  { return $('min-vol-sel').value; }

function populateSidebar(s){
  const ce=$('m-close'); ce.textContent=fmt(s.close); ce.className='metric-value';
  if(s.vwap!=null && s.close!=null) ce.classList.add(s.close>=s.vwap?'val-up':'val-dn');
  $('m-vwap').textContent=fmt(s.vwap);
  const de=$('m-vwap-dev'), dv=s.vwap_dev_pct;
  de.textContent=dv!=null?`${fmt(dv,3)} %`:'â€”'; de.className='metric-value';
  if(dv!=null) de.classList.add(dv>0?'val-up':'val-dn');
  $('m-gravity').textContent=fmt(s.gravity);
  $('m-fib0').textContent=s.fib0!=null?fmt(s.fib0):'â€”';
  $('m-fib50').textContent=s.fib50!=null?fmt(s.fib50):'â€”';
  $('m-fib100').textContent=s.fib100!=null?fmt(s.fib100):'â€”';
  $('m-hh').textContent=s.hh_daily; $('m-ll').textContent=s.ll_daily;
  $('m-hl').textContent=s.daily_hl_diff!=null?fmt(s.daily_hl_diff):'â€”';
  $('m-vol').textContent=s.daily_vol;
  $('m-z1').textContent=s.zone_above_l1; $('m-z2').textContent=s.zone_l1_l2;
  $('m-z3').textContent=s.zone_l2_l3;    $('m-z4').textContent=s.zone_below_l3;
  $('m-don').innerHTML=donBadge(s.don_main);
  $('m-allgreen').innerHTML=badge(s.all_green,'YES âœ“','NO','badge-green','badge-gray');
  $('m-allred').innerHTML=badge(s.all_red,'YES âœ“','NO','badge-red','badge-gray');
  $('m-majfall').innerHTML=badge(s.major_fall,'ACTIVE âš ','NO','badge-red','badge-gray');
  $('m-brise').innerHTML=badge(s.basic_rise,'YES â–²','NO','badge-green','badge-gray');
  $('m-crise').innerHTML=badge(s.confirmed_rise,'YES â–²â–²','NO','badge-green','badge-gray');
  $('m-erise').innerHTML=badge(s.explosive_rise,'YES ğŸš€','NO','badge-blue','badge-gray');
  $('m-prise').innerHTML=badge(s.parabolic_rise,'YES âš¡','NO','badge-gold','badge-gray');
  $('m-escape').innerHTML=badge(s.escape,'YES â†‘','NO','badge-purple','badge-gray');
  $('m-crash').innerHTML=badge(s.crash_risk,'RISK âš ','NO','badge-red','badge-gray');
  $('m-g2r').innerHTML=badge(s.signal_green_to_red,'FLIP â†“','NO','badge-red','badge-gray');
  $('m-r2g').innerHTML=badge(s.signal_red_to_green,'FLIP â†‘','NO','badge-green','badge-gray');
  $('m-datetime').textContent='Updated: '+(s.datetime||'â€”');
}

async function loadScreener(){
  const res=await fetch(`/screener/${getTicker()}?range=${getRange()}&interval=${getInterval()}`);
  const j=await res.json(); if(j.error) throw new Error(j.error);
  populateSidebar(j.summary); return j;
}

async function loadChart(){
  const url=`/chart/${getTicker()}?range=${getRange()}&interval=${getInterval()}&min_vol=${getMinVol()}&_t=${Date.now()}`;
  showLoading('Generating chartâ€¦');
  try {
    const res=await fetch(url);
    if(!res.ok){const j=await res.json().catch(()=>({})); throw new Error(j.error||`HTTP ${res.status}`);}
    const img=$('chart-img');
    img.onload=()=>{ $('placeholder').style.display='none'; img.style.display='block'; };
    img.src=URL.createObjectURL(await res.blob());
    setStatus(`âœ“ ${getTicker()} â€” chart ready`,'#26a641');
  } catch(e){ setStatus('Chart error: '+e.message,'#f85149'); }
  finally { hideLoading(); }
}

async function loadAll(silent=false){
  const t=getTicker();
  if(!silent){
    showLoading('Fetching dataâ€¦'); setStatus('Loadingâ€¦','#8b949e');
    document.querySelectorAll('.metric-value').forEach(el=>{el.textContent='â€”';el.className='metric-value';});
    $('m-datetime').textContent='â€”';
  }
  if(!silent) countdown=REFRESH_SECS;
  try {
    const[r]=await Promise.all([loadScreener(),loadChart()]);
    setStatus(`âœ“ ${t}  Â·  ${r.bars} bars`,'#26a641');
  } catch(e){ setStatus('Error: '+e.message,'#f85149'); hideLoading(); }
}

$('ticker-search').addEventListener('keydown', e=>{
  if(e.key==='Enter'){closeDD();loadAll();}
  if(e.key==='Escape') closeDD();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCANNER TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sigTags(r,type){
  const t=[];
  if(type==='buy'){
    if(r.signal_r2g)     t.push('<span class="badge badge-green">Râ†’G</span>');
    if(r.explosive_rise) t.push('<span class="badge badge-blue">Explosive</span>');
    if(r.confirmed_rise) t.push('<span class="badge badge-green">Confirmed</span>');
    if(r.parabolic_rise) t.push('<span class="badge badge-gold">Parabolic</span>');
    if(r.all_green)      t.push('<span class="badge badge-green">AllGreen</span>');
    if(r.escape)         t.push('<span class="badge badge-purple">Escape</span>');
  } else {
    if(r.signal_g2r)  t.push('<span class="badge badge-red">Gâ†’R</span>');
    if(r.major_fall)  t.push('<span class="badge badge-red">MajFall</span>');
    if(r.crash_risk)  t.push('<span class="badge badge-red">Crash</span>');
    if(r.all_red)     t.push('<span class="badge badge-red">AllRed</span>');
  }
  return t.length?t.join(' '):'<span style="color:#8b949e">â€”</span>';
}
function scoreBar(score,max,type){
  return `${score}<span class="score-bar ${type}" style="width:${Math.min(50,(score/max)*50)}px"></span>`;
}
function renderScanTable(tbody,rows,type){
  if(!rows.length){tbody.innerHTML=`<tr><td colspan="8" style="text-align:center;color:#8b949e;padding:20px">No results</td></tr>`;return;}
  const mx=Math.max(...rows.map(r=>type==='buy'?r.buy_score:r.sell_score),1);
  tbody.innerHTML=rows.map((r,i)=>{
    const score=type==='buy'?r.buy_score:r.sell_score;
    const st=type==='buy'?r.buy_signal_time:r.sell_signal_time;
    const tstr=st?`<span style="color:#ffd700;font-weight:700">â° ${st}</span>`:'<span style="color:#8b949e">â€”</span>';
    const dv=r.vwap_dev_pct;
    const ds=dv!=null?`<span style="color:${dv>0?'#26a641':'#f85149'}">${Number(dv).toFixed(2)}%</span>`:'â€”';
    return `<tr onclick="jumpToChart('${r.ticker}')">
      <td style="color:#8b949e">${i+1}</td>
      <td style="font-weight:700">${r.ticker.replace('.NS','')}</td>
      <td>${r.close!=null?Number(r.close).toFixed(2):'â€”'}</td>
      <td>${ds}</td>
      <td style="color:#ffa657">${r.daily_vol||'â€”'}</td>
      <td>${sigTags(r,type)}</td>
      <td>${tstr}</td>
      <td>${scoreBar(score,mx,type)}</td>
    </tr>`;
  }).join('');
}
function jumpToChart(ticker){ selectTicker(ticker); switchTab('chart'); loadAll(); }

async function runScanner(){
  const interval=$('scan-interval-sel').value, topN=$('scan-topn-sel').value;
  $('scan-status-inline').textContent='Scanningâ€¦';
  $('scan-progress-wrap').style.display='block';
  $('scan-progress-bar').style.width='10%';
  $('scan-status').textContent=`â³ Scanning ${SYMBOLS.length} symbolsâ€¦`;
  $('buy-tbody').innerHTML=`<tr><td colspan="8" style="text-align:center;padding:24px"><div class="spinner" style="margin:0 auto"></div></td></tr>`;
  $('sell-tbody').innerHTML=`<tr><td colspan="8" style="text-align:center;padding:24px"><div class="spinner" style="margin:0 auto"></div></td></tr>`;
  let prog=10;
  const pi=setInterval(()=>{ prog=Math.min(prog+3,90); $('scan-progress-bar').style.width=prog+'%'; },800);
  try {
    const t0=Date.now();
    const res=await fetch(`/scan?interval=${interval}&top_n=${topN}`);
    const data=await res.json();
    clearInterval(pi);
    $('scan-progress-bar').style.width='100%';
    setTimeout(()=>{ $('scan-progress-wrap').style.display='none'; $('scan-progress-bar').style.width='0%'; },600);
    if(data.error) throw new Error(data.error);
    renderScanTable($('buy-tbody'),data.top_buy,'buy');
    renderScanTable($('sell-tbody'),data.top_sell,'sell');
    $('buy-count').textContent=`Top ${data.top_buy.length}`;
    $('sell-count').textContent=`Top ${data.top_sell.length}`;
    const el=((Date.now()-t0)/1000).toFixed(1);
    $('scan-status').textContent=`âœ“ Scanned ${data.scanned} in ${el}s Â· ${data.errors} errors Â· ${new Date().toLocaleTimeString('en-IN',{timeZone:'Asia/Kolkata'})} IST`;
    $('scan-status-inline').textContent=`Last: ${new Date().toLocaleTimeString('en-IN',{timeZone:'Asia/Kolkata'})} IST`;
  } catch(e){ clearInterval(pi); $('scan-progress-wrap').style.display='none'; $('scan-status').textContent='âœ— '+e.message; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REPLAY ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RPL = {
  candles : [],     // all session candles (IST filtered)
  cursor  : 0,      // number drawn so far (0 = nothing shown)
  timer   : null,
  playing : false,
  PL:62, PR:18, PT:28, PB:34,  // canvas padding

  // â”€â”€ helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  cv ()  { return document.getElementById('rpl-canvas'); },
  ctx()  { return this.cv().getContext('2d'); },
  speed(){ return parseInt(document.getElementById('rpl-speed-sel').value, 10); },

  // â”€â”€ resize canvas to its container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  resize(){
    const cv  = this.cv();
    const bod = document.getElementById('replay-body');
    const w   = bod.offsetWidth;
    const h   = bod.offsetHeight;
    if (w > 0 && h > 0) { cv.width = w; cv.height = h; }
  },

  // â”€â”€ load OHLCV + indicators from /replay_data/ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async load(ticker){
    // Use replay_data which returns per-bar indicator values (IST-filtered)
    const res  = await fetch('/replay_data/' + ticker + '?interval=1m');
    const json = await res.json();
    if (json.error) throw new Error(json.error);

    this.candles = json.data || [];
    if (!this.candles.length) throw new Error('No session candles');

    this.cursor  = 0;
    this.playing = false;

    this.resize();
    this.draw();
    this.syncUI();
    return this.candles.length;
  },

  // â”€â”€ play / pause toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  playPause(){
    if (!this.candles.length) return;
    if (this.playing) {
      this.pause();
    } else {
      if (this.cursor >= this.candles.length) this.cursor = 0;
      this.playing = true;
      document.getElementById('rpl-play-btn').textContent = 'â¸ Pause';
      document.getElementById('rpl-stop-btn').disabled    = false;
      this._tick();
    }
  },

  pause(){
    this.playing = false;
    clearTimeout(this.timer);
    document.getElementById('rpl-play-btn').textContent = 'â–¶ Play';
  },

  _tick(){
    if (!this.playing) return;
    if (this.cursor < this.candles.length) {
      this.cursor++;
      this.draw();
      this.syncUI();
      this.timer = setTimeout(() => this._tick(), this.speed());
    } else {
      this.pause();   // reached end
    }
  },

  // â”€â”€ stop: pause + go to start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  stop(){
    this.pause();
    this.cursor = 0;
    this.draw();
    this.syncUI();
    document.getElementById('rpl-stop-btn').disabled = true;
  },

  // â”€â”€ reset: pause + rewind â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  reset(){
    this.pause();
    this.cursor = 0;
    this.draw();
    this.syncUI();
  },

  // â”€â”€ seek by fraction 0-1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  seek(frac){
    if (!this.candles.length) return;
    this.cursor = Math.round(frac * this.candles.length);
    this.cursor = Math.max(0, Math.min(this.cursor, this.candles.length));
    this.draw();
    this.syncUI();
  },

  // â”€â”€ sync progress bar / time label / counters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  syncUI(){
    const total = this.candles.length;
    const cur   = this.cursor;
    document.getElementById('rpl-candle-label').textContent = cur + ' / ' + total;
    document.getElementById('rpl-progress-bar').style.width = (total ? cur/total*100 : 0) + '%';
    const last = cur > 0 ? this.candles[cur - 1] : null;
    document.getElementById('rpl-time-label').textContent = last ? last.date.slice(11,16) : '--:--';
    document.getElementById('rpl-play-btn').disabled  = total === 0;
    document.getElementById('rpl-reset-btn').disabled = total === 0;
  },

  // â”€â”€ main draw routine â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  draw(){
    const cv  = this.cv(), ctx = this.ctx();
    const W = cv.width, H = cv.height;
    if (!W || !H) return;               // guard: canvas not yet laid out
    const {PL,PR,PT,PB} = this;
    const chartW = W - PL - PR;
    const chartH = H - PT - PB;

    ctx.fillStyle = '#0d1117';
    ctx.fillRect(0, 0, W, H);

    const total   = this.candles.length;
    const visible = this.candles.slice(0, this.cursor);

    // â”€â”€ empty / no-data state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (!visible.length) {
      ctx.fillStyle = '#8b949e';
      ctx.font      = '14px Segoe UI,sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(
        total ? ('Press â–¶ Play â€” ' + total + ' candles loaded') : 'Press ğŸ“¥ Load Data to begin',
        W/2, H/2
      );
      ctx.textAlign = 'left';
      if (total) this._timeAxis(ctx, W, H, PL, PR, PT, PB, total, null);
      return;
    }

    // â”€â”€ sizing: fixed slot = total candles across full width â”€
    // Candle i always sits at the same X regardless of cursor position.
    // This makes the time axis stable and the chart feel like a real platform.
    const slotW   = chartW / total;
    const candleW = Math.max(1.5, slotW * 0.70);
    const hw      = candleW / 2;
    const toX     = i => PL + (i + 0.5) * slotW;

    // â”€â”€ price range (auto-scale from visible only) â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let hi = -Infinity, lo = Infinity;
    for (const c of visible) { if(c.high>hi) hi=c.high; if(c.low<lo) lo=c.low; }
    const pad  = (hi - lo) * 0.08 || hi * 0.005 || 1;
    const yMin = lo - pad, yMax = hi + pad;
    const toY  = v => PT + (1 - (v - yMin)/(yMax - yMin)) * chartH;

    // â”€â”€ horizontal grid + Y labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ctx.font      = '10px Segoe UI,sans-serif';
    ctx.fillStyle = '#8b949e';
    ctx.textAlign = 'right';
    for (let i = 0; i <= 5; i++) {
      const f  = i / 5;
      const yp = PT + f * chartH;
      const yv = yMax - f * (yMax - yMin);
      ctx.strokeStyle = '#1c2128'; ctx.lineWidth = 0.8;
      ctx.beginPath(); ctx.moveTo(PL, yp); ctx.lineTo(W-PR, yp); ctx.stroke();
      ctx.fillText(yv.toFixed(2), PL - 4, yp + 3);
    }
    ctx.textAlign = 'left';

    // â”€â”€ VWAP line (from indicator data, fallback to computed) â”€â”€
    ctx.beginPath(); ctx.strokeStyle = '#58a6ff'; ctx.lineWidth = 1.5;
    let cumPV = 0, cumV = 0;
    visible.forEach((c, i) => {
      let vwap = c.vwap;
      if (vwap == null) {                        // fallback: compute inline
        const hlc3 = (c.high + c.low + c.close) / 3;
        cumPV += hlc3 * c.volume; cumV += c.volume;
        vwap = cumV ? cumPV / cumV : hlc3;
      }
      const xp = toX(i), yp = toY(vwap);
      i === 0 ? ctx.moveTo(xp, yp) : ctx.lineTo(xp, yp);
    });
    ctx.stroke();

    // â”€â”€ Gravity / CoG line â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let gravStarted = false;
    ctx.beginPath(); ctx.strokeStyle = '#d2a8ff'; ctx.lineWidth = 1.2;
    ctx.setLineDash([5, 3]);
    visible.forEach((c, i) => {
      if (c.gravity == null) return;
      const xp = toX(i), yp = toY(c.gravity);
      if (!gravStarted) { ctx.moveTo(xp, yp); gravStarted = true; }
      else ctx.lineTo(xp, yp);
    });
    ctx.stroke(); ctx.setLineDash([]);

    // â”€â”€ ORB levels (horizontal lines from first bar that has them) â”€
    const orbBar = visible.find(c => c.fib0 != null);
    if (orbBar) {
      const orbLevels = [
        { v: orbBar.fib0,   col: '#3fb950', lbl: 'ORB H' },
        { v: orbBar.fib50,  col: '#58a6ff', lbl: 'ORB M' },
        { v: orbBar.fib100, col: '#f85149', lbl: 'ORB L' },
      ];
      orbLevels.forEach(({ v, col, lbl }) => {
        if (v == null) return;
        const yp = toY(v);
        ctx.strokeStyle = col; ctx.lineWidth = 0.8;
        ctx.setLineDash([3, 4]);
        ctx.beginPath(); ctx.moveTo(PL, yp); ctx.lineTo(W - PR, yp); ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle = col; ctx.font = '9px Segoe UI,sans-serif';
        ctx.fillText(lbl + ' ' + v.toFixed(2), W - PR - 56, yp - 2);
      });
    }

    // â”€â”€ candles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    visible.forEach((c, i) => {
      const xc   = toX(i);
      const bull = c.close >= c.open;
      const col  = bull ? '#26a641' : '#f85149';
      const yO=toY(c.open), yC=toY(c.close), yH=toY(c.high), yL=toY(c.low);
      ctx.strokeStyle = col; ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(xc, yH); ctx.lineTo(xc, yL); ctx.stroke();
      ctx.fillStyle = col;
      ctx.fillRect(xc - hw, Math.min(yO,yC), candleW, Math.max(1, Math.abs(yC-yO)));
    });

    // â”€â”€ signal markers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Draw above/below candles using marker characters
    const SIG_R = Math.max(4, candleW * 1.6);   // marker radius
    visible.forEach((c, i) => {
      const xc = toX(i);

      // â”€â”€ BUY signals â†’ below candle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const buyY = toY(c.low) + SIG_R + 4;
      if (c.signal_r2g) {
        _drawMarker(ctx, xc, buyY, 'â–²', '#26a641', SIG_R * 2, 'bold');
      } else if (c.parabolic_rise) {
        _drawMarker(ctx, xc, buyY, 'â–²', '#ffd700', SIG_R * 1.8, 'bold');
      } else if (c.explosive_rise) {
        _drawMarker(ctx, xc, buyY, 'â–²', '#58a6ff', SIG_R * 1.6, '');
      } else if (c.confirmed_rise) {
        _drawMarker(ctx, xc, buyY, 'â–²', '#3fb950', SIG_R * 1.4, '');
      } else if (c.basic_rise) {
        _drawMarker(ctx, xc, buyY, 'â–²', '#8b949e', SIG_R * 1.2, '');
      } else if (c.escape) {
        _drawMarker(ctx, xc, buyY, 'â—†', '#d2a8ff', SIG_R * 1.4, 'bold');
      }

      // â”€â”€ SELL signals â†’ above candle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const sellY = toY(c.high) - SIG_R - 4;
      if (c.signal_g2r) {
        _drawMarker(ctx, xc, sellY, 'â–¼', '#f85149', SIG_R * 2, 'bold');
      } else if (c.crash_risk) {
        _drawMarker(ctx, xc, sellY, 'â–¼', '#ff7b72', SIG_R * 1.8, 'bold');
      } else if (c.major_fall) {
        _drawMarker(ctx, xc, sellY, 'â–¼', '#ffa657', SIG_R * 1.6, '');
      }
    });

    // â”€â”€ current price line â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const last  = visible[visible.length - 1];
    const lastY = toY(last.close);
    const bull  = last.close >= last.open;
    const pcol  = bull ? '#26a641' : '#f85149';
    ctx.strokeStyle = pcol; ctx.lineWidth = 0.9;
    ctx.setLineDash([4, 3]);
    ctx.beginPath(); ctx.moveTo(PL, lastY); ctx.lineTo(W-PR, lastY); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = pcol; ctx.font = 'bold 10px Segoe UI,sans-serif';
    ctx.fillText(last.close.toFixed(2), W - PR + 2, lastY + 3);

    // â”€â”€ time axis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    this._timeAxis(ctx, W, H, PL, PR, PT, PB, total, toX);

    // â”€â”€ OHLCV + active signals info bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const b2   = last.close >= last.open;
    const sigs = [];
    if (last.signal_r2g)     sigs.push('<span style="color:#26a641;font-weight:700">Râ†’G</span>');
    if (last.signal_g2r)     sigs.push('<span style="color:#f85149;font-weight:700">Gâ†’R</span>');
    if (last.parabolic_rise) sigs.push('<span style="color:#ffd700">Parabolic</span>');
    if (last.explosive_rise) sigs.push('<span style="color:#58a6ff">Explosive</span>');
    if (last.confirmed_rise) sigs.push('<span style="color:#3fb950">Confirmed</span>');
    if (last.basic_rise)     sigs.push('<span style="color:#8b949e">Basicâ†‘</span>');
    if (last.crash_risk)     sigs.push('<span style="color:#ff7b72">Crashâš </span>');
    if (last.major_fall)     sigs.push('<span style="color:#ffa657">MajFall</span>');
    if (last.escape)         sigs.push('<span style="color:#d2a8ff">Escape</span>');
    document.getElementById('rpl-ohlcv').innerHTML =
      'O <b style="color:' + (b2?'#26a641':'#f85149') + '">' + last.open.toFixed(2)  + '</b>  ' +
      'H <b style="color:#26a641">'                          + last.high.toFixed(2)  + '</b>  ' +
      'L <b style="color:#f85149">'                          + last.low.toFixed(2)   + '</b>  ' +
      'C <b style="color:' + (b2?'#26a641':'#f85149') + '">' + last.close.toFixed(2) + '</b>  ' +
      'Vol <b style="color:#ffa657">'                        + (last.volume/1e6).toFixed(2) + 'M</b>' +
      (sigs.length ? '  &nbsp;' + sigs.join(' &nbsp;') : '');
  },

  // â”€â”€ marker drawing helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // (module-level function so draw() can call it)

  // â”€â”€ time axis with dotted rules â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _timeAxis(ctx, W, H, PL, PR, PT, PB, total, toX){
    const MARKS = ['09:15','09:30','10:00','10:30','11:00','11:30',
                   '12:00','12:30','13:00','13:30','14:00','14:30','15:00','15:30'];
    const slotW = (W - PL - PR) / total;
    ctx.font      = '9px Segoe UI,sans-serif';
    ctx.fillStyle = '#8b949e';
    ctx.textAlign = 'center';

    MARKS.forEach(t => {
      // Find candle with this time label
      const idx = this.candles.findIndex(c => c.date.slice(11,16) === t);
      let xp;
      if (idx >= 0 && toX) {
        xp = toX(idx);
      } else {
        // approximate from session minutes
        const [hh, mm] = t.split(':').map(Number);
        const mins = hh*60 + mm - (9*60 + 15);
        xp = PL + mins * slotW + slotW * 0.5;
      }

      ctx.strokeStyle = '#21262d'; ctx.lineWidth = 0.5;
      ctx.setLineDash([2, 2]);
      ctx.beginPath(); ctx.moveTo(xp, PT); ctx.lineTo(xp, H-PB); ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillText(t, xp, H - PB + 12);
    });
    ctx.textAlign = 'left';
  },

  // â”€â”€ hover: show OHLCV for candle under mouse â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  onHover(mx){
    const vis = this.candles.slice(0, this.cursor);
    if (!vis.length) return;
    const slotW = (this.cv().width - this.PL - this.PR) / this.candles.length;
    const idx   = Math.floor((mx - this.PL) / slotW);
    if (idx < 0 || idx >= vis.length) return;
    const c = vis[idx], b = c.close >= c.open;
    document.getElementById('rpl-ohlcv').innerHTML =
      '<b style="color:#ffd700">' + c.date.slice(11,16) + '</b>  ' +
      'O <b style="color:' + (b?'#26a641':'#f85149') + '">' + c.open.toFixed(2)  + '</b>  ' +
      'H <b style="color:#26a641">'                         + c.high.toFixed(2)  + '</b>  ' +
      'L <b style="color:#f85149">'                         + c.low.toFixed(2)   + '</b>  ' +
      'C <b style="color:' + (b?'#26a641':'#f85149') + '">' + c.close.toFixed(2) + '</b>  ' +
      'Vol <b style="color:#ffa657">'                       + (c.volume/1e6).toFixed(2) + 'M</b>';
  },
};

// â”€â”€ Marker drawing helper (used inside RPL.draw) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _drawMarker(ctx, x, y, char, color, size, weight) {
  ctx.save();
  ctx.fillStyle  = color;
  ctx.font       = (weight ? weight + ' ' : '') + size + 'px Segoe UI,sans-serif';
  ctx.textAlign  = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(char, x, y);
  ctx.restore();
}

// â”€â”€ Replay button handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function rplLoad(){
  const btn = $('rpl-load-btn');
  btn.disabled = true;
  btn.textContent = 'â³ Loadingâ€¦';
  try {
    // ensure canvas dimensions are correct before drawing
    RPL.resize();
    const n = await RPL.load(getTicker());
    btn.textContent = 'âœ“ ' + getTicker().replace('.NS','') + ' â€” ' + n + ' bars';
    $('rpl-play-btn').disabled  = false;
    $('rpl-reset-btn').disabled = false;
  } catch(e) {
    btn.textContent = 'ğŸ“¥ Load Data';
    alert('Load failed: ' + e.message);
  } finally {
    btn.disabled = false;
  }
}
function rplPlayPause(){ RPL.playPause(); }
function rplStop()     { RPL.stop(); }
function rplReset()    { RPL.reset(); }

$('rpl-progress-wrap').addEventListener('click', e => {
  const rect = $('rpl-progress-wrap').getBoundingClientRect();
  RPL.seek(Math.max(0, Math.min(1, (e.clientX-rect.left)/rect.width)));
});

$('rpl-canvas').addEventListener('mousemove', e => {
  const rect = $('rpl-canvas').getBoundingClientRect();
  RPL.onHover(e.clientX - rect.left);
});

// â”€â”€ Init canvas on page load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load', () => {
  RPL.resize();
  RPL.draw();
});
window.addEventListener('resize', () => { RPL.resize(); RPL.draw(); });

// â”€â”€ Init dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
buildList('');
</script>
</body>
</html>
