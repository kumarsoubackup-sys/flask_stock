<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>NSE Screener</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: #0d1117; color: #c9d1d9;
    font-family: 'Segoe UI', system-ui, sans-serif; font-size: 13px;
    height: 100vh; display: flex; flex-direction: column; overflow: hidden;
  }

  /* â”€â”€ TOP BAR â”€â”€ */
  #topbar {
    display: flex; align-items: center; gap: 10px;
    padding: 8px 14px; background: #161b22;
    border-bottom: 1px solid #21262d; flex-shrink: 0; flex-wrap: wrap;
  }
  #topbar h1 { font-size: 15px; font-weight: 700; color: #58a6ff; white-space: nowrap; }

  /* â”€â”€ TABS â”€â”€ */
  #tab-bar {
    display: flex; gap: 0;
    background: #161b22; border-bottom: 1px solid #21262d; flex-shrink: 0;
  }
  .tab-btn {
    padding: 8px 22px; cursor: pointer; font-size: 13px; font-weight: 600;
    color: #8b949e; border: none; background: transparent;
    border-bottom: 2px solid transparent; transition: all .15s;
  }
  .tab-btn:hover { color: #c9d1d9; }
  .tab-btn.active { color: #58a6ff; border-bottom-color: #58a6ff; }

  /* â”€â”€ TAB PANELS â”€â”€ */
  .tab-panel { display: none; flex: 1; overflow: hidden; }
  .tab-panel.active { display: flex; }

  /* â”€â”€ TICKER DROPDOWN â”€â”€ */
  .ticker-wrap { position: relative; width: 210px; flex-shrink: 0; }
  #ticker-search {
    width: 100%; padding: 5px 28px 5px 10px;
    background: #0d1117; border: 1px solid #30363d; border-radius: 6px;
    color: #c9d1d9; font-size: 13px; outline: none; cursor: pointer;
  }
  #ticker-search::placeholder { color: #8b949e; }
  #ticker-search:focus { border-color: #58a6ff; }
  .ticker-arrow { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: #8b949e; pointer-events: none; font-size: 10px; }
  #ticker-dropdown {
    position: absolute; top: calc(100% + 4px); left: 0; right: 0;
    background: #161b22; border: 1px solid #30363d; border-radius: 6px;
    max-height: 280px; overflow-y: auto; z-index: 200; display: none;
    box-shadow: 0 8px 24px rgba(0,0,0,.6);
  }
  #ticker-dropdown.open { display: block; }
  #dd-search-input {
    width: 100%; padding: 6px 10px;
    background: #0d1117; border: none; border-bottom: 1px solid #30363d;
    color: #c9d1d9; font-size: 12px; outline: none;
  }
  .dd-item { padding: 6px 12px; cursor: pointer; font-size: 12px; color: #c9d1d9; white-space: nowrap; }
  .dd-item:hover, .dd-item.highlighted { background: #1f6feb; color: #fff; }

  select {
    padding: 5px 8px; background: #0d1117; border: 1px solid #30363d;
    border-radius: 6px; color: #c9d1d9; font-size: 13px; outline: none; cursor: pointer;
  }
  select:focus { border-color: #58a6ff; }

  .btn {
    padding: 5px 14px; border-radius: 6px; border: none;
    font-size: 13px; font-weight: 600; cursor: pointer; transition: opacity .15s; white-space: nowrap;
  }
  .btn:hover { opacity: .85; }
  .btn-blue  { background: #1f6feb; color: #fff; }
  .btn-gray  { background: #21262d; color: #c9d1d9; }
  .btn-green { background: #1a7a3a; color: #fff; }

  #countdown {
    font-size: 11px; color: #8b949e; padding: 3px 9px;
    border: 1px solid #30363d; border-radius: 12px;
    background: #0d1117; min-width: 72px; text-align: center; white-space: nowrap;
  }
  #countdown.ticking { color: #58a6ff; border-color: #1f6feb; }
  #status { margin-left: auto; font-size: 12px; color: #8b949e; white-space: nowrap; }

  /* â”€â”€ SIDEBAR â”€â”€ */
  #sidebar {
    width: 220px; min-width: 220px; background: #161b22;
    border-right: 1px solid #21262d; overflow-y: auto;
    padding: 10px 8px; display: flex; flex-direction: column; gap: 10px;
  }
  .section-title {
    font-size: 10px; font-weight: 700; letter-spacing: .08em;
    text-transform: uppercase; color: #8b949e;
    padding: 4px 4px 2px; border-bottom: 1px solid #21262d; margin-bottom: 2px;
  }
  .metric-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 3px 4px; border-radius: 4px;
  }
  .metric-row:hover { background: #1c2128; }
  .metric-label { color: #8b949e; font-size: 12px; }
  .metric-value { font-size: 12px; font-weight: 600; color: #c9d1d9; text-align: right; }

  .val-up     { color: #26a641 !important; }
  .val-dn     { color: #f85149 !important; }
  .val-gold   { color: #ffa657 !important; }
  .val-blue   { color: #58a6ff !important; }
  .val-purple { color: #d2a8ff !important; }

  .badge { display: inline-block; padding: 1px 7px; border-radius: 10px; font-size: 11px; font-weight: 700; }
  .badge-green  { background: #1a3a1a; color: #26a641; border: 1px solid #26a641; }
  .badge-red    { background: #3a1a1a; color: #f85149; border: 1px solid #f85149; }
  .badge-gray   { background: #1c2128; color: #8b949e; border: 1px solid #30363d; }
  .badge-gold   { background: #3a2a00; color: #ffa657; border: 1px solid #ffa657; }
  .badge-blue   { background: #0c2340; color: #58a6ff; border: 1px solid #58a6ff; }
  .badge-purple { background: #2a1a40; color: #d2a8ff; border: 1px solid #d2a8ff; }

  /* â”€â”€ CHART AREA â”€â”€ */
  #chart-area {
    flex: 1; overflow: hidden; display: flex;
    flex-direction: column; align-items: center; justify-content: center;
    background: #0d1117; position: relative;
  }
  #chart-img { max-width: 100%; max-height: 100%; object-fit: contain; display: none; }
  #placeholder { display: flex; flex-direction: column; align-items: center; gap: 12px; color: #8b949e; }
  #placeholder svg { opacity: .3; }
  #placeholder p { font-size: 14px; }
  #loading-overlay {
    position: absolute; inset: 0; background: rgba(13,17,23,.75);
    display: none; align-items: center; justify-content: center;
    flex-direction: column; gap: 12px; z-index: 10;
  }
  .spinner { width: 36px; height: 36px; border: 3px solid #21262d; border-top-color: #58a6ff; border-radius: 50%; animation: spin .7s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  #loading-overlay p { color: #8b949e; font-size: 13px; }

  /* â”€â”€ SCANNER TAB â”€â”€ */
  #scanner-panel {
    flex: 1; overflow: hidden; flex-direction: column; background: #0d1117;
  }
  #scanner-toolbar {
    display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
    padding: 10px 16px; background: #161b22; border-bottom: 1px solid #21262d; flex-shrink: 0;
  }
  #scanner-toolbar span { font-size: 12px; color: #8b949e; }
  #scanner-content {
    flex: 1; overflow-y: auto; padding: 16px;
    display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
  }
  .scan-table-wrap { background: #161b22; border: 1px solid #21262d; border-radius: 8px; overflow: hidden; }
  .scan-table-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 14px; border-bottom: 1px solid #21262d;
  }
  .scan-table-title { font-size: 13px; font-weight: 700; }
  .scan-table-title.buy  { color: #26a641; }
  .scan-table-title.sell { color: #f85149; }
  .scan-badge { font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
  .scan-badge.buy  { background: #1a3a1a; color: #26a641; }
  .scan-badge.sell { background: #3a1a1a; color: #f85149; }

  table.scan-tbl { width: 100%; border-collapse: collapse; }
  table.scan-tbl th {
    text-align: left; padding: 7px 10px; font-size: 10px; font-weight: 700;
    letter-spacing: .06em; text-transform: uppercase; color: #8b949e;
    background: #0d1117; border-bottom: 1px solid #21262d; white-space: nowrap;
  }
  table.scan-tbl td {
    padding: 7px 10px; font-size: 12px; border-bottom: 1px solid #161b22;
    white-space: nowrap;
  }
  table.scan-tbl tr:last-child td { border-bottom: none; }
  table.scan-tbl tr:hover td { background: #1c2128; cursor: pointer; }
  .score-bar {
    display: inline-block; height: 6px; border-radius: 3px; vertical-align: middle;
    margin-left: 6px;
  }
  .score-bar.buy  { background: #26a641; }
  .score-bar.sell { background: #f85149; }

  #scan-status {
    padding: 6px 16px; font-size: 11px; color: #8b949e;
    background: #161b22; border-top: 1px solid #21262d;
    flex-shrink: 0;
  }

  /* progress bar */
  #scan-progress-wrap {
    width: 260px; height: 6px; background: #21262d; border-radius: 3px; overflow: hidden;
  }
  #scan-progress-bar { height: 100%; width: 0%; background: #1f6feb; transition: width .2s; }

  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 3px; }
</style>
</head>
<body>

<!-- TOP BAR -->
<div id="topbar">
  <h1>ğŸ“ˆ NSE Screener</h1>
  <div class="ticker-wrap" id="ticker-wrap">
    <input id="ticker-search" type="text" placeholder="Search symbolâ€¦" autocomplete="off" value="RELIANCE.NS"/>
    <span class="ticker-arrow">â–¼</span>
    <div id="ticker-dropdown">
      <input id="dd-search-input" type="text" placeholder="Filterâ€¦" autocomplete="off"/>
      <div id="dd-list"></div>
    </div>
  </div>
  <select id="range-sel">
    <option value="1d" selected>1 Day</option>
    <option value="5d">5 Days</option>
    <option value="1mo">1 Month</option>
  </select>
  <select id="interval-sel">
    <option value="1m" selected>1 min</option>
    <option value="5m">5 min</option>
    <option value="15m">15 min</option>
  </select>
  <select id="min-vol-sel" title="Min Volume threshold">
    <option value="5000000">Vol â‰¥ 5M</option>
    <option value="6000000" selected>Vol â‰¥ 6M</option>
    <option value="7000000">Vol â‰¥ 7M</option>
    <option value="8000000">Vol â‰¥ 8M</option>
    <option value="9000000">Vol â‰¥ 9M</option>
    <option value="10000000">Vol â‰¥ 10M</option>
  </select>
  <button class="btn btn-blue" onclick="loadAll()">Load</button>
  <button class="btn btn-gray"  onclick="loadChart()">Chart Only</button>
  <span id="countdown">â± 60s</span>
  <span id="status">â€”</span>
</div>

<!-- TAB BAR -->
<div id="tab-bar">
  <button class="tab-btn active" onclick="switchTab('chart')">ğŸ“Š Chart</button>
  <button class="tab-btn"        onclick="switchTab('scanner')">ğŸ” Scanner</button>
</div>

<!-- CHART TAB -->
<div id="chart-panel" class="tab-panel active">
  <div id="sidebar">
    <div>
      <div class="section-title">Price &amp; VWAP</div>
      <div class="metric-row"><span class="metric-label">Close</span><span class="metric-value" id="m-close">â€”</span></div>
      <div class="metric-row"><span class="metric-label">VWAP</span><span class="metric-value" id="m-vwap">â€”</span></div>
      <div class="metric-row"><span class="metric-label">VWAP Dev %</span><span class="metric-value" id="m-vwap-dev">â€”</span></div>
      <div class="metric-row"><span class="metric-label">Gravity (CoG)</span><span class="metric-value val-purple" id="m-gravity">â€”</span></div>
    </div>
    <div>
      <div class="section-title">ORB Levels</div>
      <div class="metric-row"><span class="metric-label">ORB 0% (High)</span><span class="metric-value val-up" id="m-fib0">â€”</span></div>
      <div class="metric-row"><span class="metric-label">ORB 50% (Mid)</span><span class="metric-value val-blue" id="m-fib50">â€”</span></div>
      <div class="metric-row"><span class="metric-label">ORB 100% (Low)</span><span class="metric-value val-dn" id="m-fib100">â€”</span></div>
    </div>
    <div>
      <div class="section-title">Daily Stats</div>
      <div class="metric-row"><span class="metric-label">Higher Highs</span><span class="metric-value val-up" id="m-hh">â€”</span></div>
      <div class="metric-row"><span class="metric-label">Lower Lows</span><span class="metric-value val-dn" id="m-ll">â€”</span></div>
      <div class="metric-row"><span class="metric-label">H-L Range</span><span class="metric-value" id="m-hl">â€”</span></div>
      <div class="metric-row"><span class="metric-label">Cum. Volume</span><span class="metric-value val-gold" id="m-vol">â€”</span></div>
    </div>
    <div>
      <div class="section-title">Zone Bar Counts</div>
      <div class="metric-row"><span class="metric-label">Above L1</span><span class="metric-value val-up" id="m-z1">â€”</span></div>
      <div class="metric-row"><span class="metric-label">L1 â†’ L2</span><span class="metric-value" id="m-z2">â€”</span></div>
      <div class="metric-row"><span class="metric-label">L2 â†’ L3</span><span class="metric-value" id="m-z3">â€”</span></div>
      <div class="metric-row"><span class="metric-label">Below L3</span><span class="metric-value val-dn" id="m-z4">â€”</span></div>
    </div>
    <div>
      <div class="section-title">Donchian Trend</div>
      <div class="metric-row"><span class="metric-label">Main Trend</span><span class="metric-value" id="m-don">â€”</span></div>
      <div class="metric-row"><span class="metric-label">All Green</span><span class="metric-value" id="m-allgreen">â€”</span></div>
      <div class="metric-row"><span class="metric-label">All Red</span><span class="metric-value" id="m-allred">â€”</span></div>
    </div>
    <div>
      <div class="section-title">Signals</div>
      <div class="metric-row"><span class="metric-label">Major Fall</span><span class="metric-value" id="m-majfall">â€”</span></div>
      <div class="metric-row"><span class="metric-label">Basic Rise</span><span class="metric-value" id="m-brise">â€”</span></div>
      <div class="metric-row"><span class="metric-label">Confirmed Rise</span><span class="metric-value" id="m-crise">â€”</span></div>
      <div class="metric-row"><span class="metric-label">Explosive Rise</span><span class="metric-value" id="m-erise">â€”</span></div>
      <div class="metric-row"><span class="metric-label">Parabolic Rise</span><span class="metric-value" id="m-prise">â€”</span></div>
      <div class="metric-row"><span class="metric-label">Escape Velocity</span><span class="metric-value" id="m-escape">â€”</span></div>
      <div class="metric-row"><span class="metric-label">Crash Risk</span><span class="metric-value" id="m-crash">â€”</span></div>
      <div class="metric-row"><span class="metric-label">G â†’ R Flip</span><span class="metric-value" id="m-g2r">â€”</span></div>
      <div class="metric-row"><span class="metric-label">R â†’ G Flip</span><span class="metric-value" id="m-r2g">â€”</span></div>
    </div>
    <div style="padding:4px;color:#8b949e;font-size:11px;" id="m-datetime">â€”</div>
  </div>
  <div id="chart-area">
    <div id="loading-overlay">
      <div class="spinner"></div>
      <p id="loading-msg">Loadingâ€¦</p>
    </div>
    <div id="placeholder">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#58a6ff" stroke-width="1.5">
        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
      </svg>
      <p>Select a symbol and press <strong>Load</strong></p>
    </div>
    <img id="chart-img" alt="Chart"/>
  </div>
</div>

<!-- SCANNER TAB -->
<div id="scanner-panel" class="tab-panel">
  <div id="scanner-toolbar">
    <select id="scan-interval-sel">
      <option value="1m" selected>1 min</option>
      <option value="5m">5 min</option>
      <option value="15m">15 min</option>
    </select>
    <select id="scan-topn-sel">
      <option value="5">Top 5</option>
      <option value="10" selected>Top 10</option>
      <option value="15">Top 15</option>
      <option value="20">Top 20</option>
    </select>
    <button class="btn btn-green" onclick="runScanner()">â–¶ Run Scanner</button>
    <div id="scan-progress-wrap" style="display:none">
      <div id="scan-progress-bar"></div>
    </div>
    <span id="scan-status-inline">Scan all 93 symbols to find top Buy &amp; Sell setups</span>
  </div>

  <div id="scanner-content">
    <!-- BUY TABLE -->
    <div class="scan-table-wrap">
      <div class="scan-table-header">
        <span class="scan-table-title buy">ğŸŸ¢ Top Buy Setups</span>
        <span class="scan-badge buy" id="buy-count">â€”</span>
      </div>
      <table class="scan-tbl" id="buy-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Symbol</th>
            <th>Close</th>
            <th>VWAP Dev%</th>
            <th>Volume</th>
            <th>Signals</th>
            <th>Signal Time</th>
            <th>Score</th>
          </tr>
        </thead>
        <tbody id="buy-tbody">
          <tr><td colspan="8" style="text-align:center;color:#8b949e;padding:24px">Press Run Scanner</td></tr>
        </tbody>
      </table>
    </div>

    <!-- SELL TABLE -->
    <div class="scan-table-wrap">
      <div class="scan-table-header">
        <span class="scan-table-title sell">ğŸ”´ Top Sell Setups</span>
        <span class="scan-badge sell" id="sell-count">â€”</span>
      </div>
      <table class="scan-tbl" id="sell-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Symbol</th>
            <th>Close</th>
            <th>VWAP Dev%</th>
            <th>Volume</th>
            <th>Signals</th>
            <th>Signal Time</th>
            <th>Score</th>
          </tr>
        </thead>
        <tbody id="sell-tbody">
          <tr><td colspan="8" style="text-align:center;color:#8b949e;padding:24px">Press Run Scanner</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="scan-status">Ready â€” press Run Scanner to begin</div>
</div>

<script>
// â”€â”€ Symbols â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SYMBOLS = [
  "ATGL.NS","NYKAA.NS","DMART.NS","BANKBARODA.NS","PGHH.NS","LTIM.NS",
  "HDFCAMC.NS","BANDHANBNK.NS","VEDL.NS","ADANIGREEN.NS","AMBUJACEM.NS",
  "PIDILITIND.NS","ICICIGI.NS","ICICIPRULI.NS","INDIGO.NS","GAIL.NS",
  "IOC.NS","MOTHERSON.NS","GLAND.NS","BAJAJHLDNG.NS","GODREJCP.NS",
  "DLF.NS","MARICO.NS","NAUKRI.NS","ACC.NS","HAVELLS.NS","HAL.NS",
  "MPHASIS.NS","LICI.NS","TORNTPHARM.NS","BEL.NS","PIIND.NS","IRCTC.NS",
  "COLPAL.NS","INDUSTOWER.NS","SBICARD.NS","BIOCON.NS","BERGEPAINT.NS",
  "TATAPOWER.NS","SIEMENS.NS","BOSCHLTD.NS","CHOLAFIN.NS","SRF.NS",
  "DABUR.NS","PAYTM.NS","MUTHOOTFIN.NS","BHARTIARTL.NS","EICHERMOT.NS",
  "SBIN.NS","AXISBANK.NS","TATASTEEL.NS","SBILIFE.NS","ADANIPORTS.NS",
  "HINDALCO.NS","JSWSTEEL.NS","ONGC.NS","ICICIBANK.NS","BPCL.NS",
  "INDUSINDBK.NS","HCLTECH.NS","SUNPHARMA.NS","WIPRO.NS","HEROMOTOCO.NS",
  "M&M.NS","INFY.NS","BAJFINANCE.NS","ADANIENT.NS","GRASIM.NS","TCS.NS",
  "HDFCLIFE.NS","ITC.NS","MARUTI.NS","UPL.NS","DRREDDY.NS","NTPC.NS",
  "RELIANCE.NS","CIPLA.NS","KOTAKBANK.NS","BAJAJFINSV.NS","HINDUNILVR.NS",
  "ASIANPAINT.NS","TECHM.NS","NESTLEIND.NS","POWERGRID.NS","LT.NS",
  "BAJAJ-AUTO.NS","BRITANNIA.NS","TATACONSUM.NS","COALINDIA.NS",
  "ULTRACEMCO.NS","DIVISLAB.NS","TITAN.NS","APOLLOHOSP.NS"
].sort();

// â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach((b, i) => {
    b.classList.toggle('active', b.textContent.toLowerCase().includes(name));
  });
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.getElementById(name + '-panel').classList.add('active');
}

// â”€â”€ DOM helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $ = id => document.getElementById(id);

// â”€â”€ Ticker dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let selectedTicker = 'RELIANCE.NS';

function buildList(filter = '') {
  const list = $('dd-list'); list.innerHTML = '';
  const q = filter.toUpperCase();
  SYMBOLS.filter(s => s.includes(q)).forEach(sym => {
    const d = document.createElement('div');
    d.className = 'dd-item' + (sym === selectedTicker ? ' highlighted' : '');
    d.textContent = sym;
    d.addEventListener('mousedown', () => selectTicker(sym));
    list.appendChild(d);
  });
}

function selectTicker(sym) { selectedTicker = sym; $('ticker-search').value = sym; closeDropdown(); }
function openDropdown()  { $('dd-search-input').value = ''; buildList(''); $('ticker-dropdown').classList.add('open'); $('dd-search-input').focus(); }
function closeDropdown() { $('ticker-dropdown').classList.remove('open'); }

$('ticker-search').addEventListener('focus', openDropdown);
$('ticker-search').addEventListener('input', function() { selectedTicker = this.value.toUpperCase(); buildList(this.value); $('ticker-dropdown').classList.add('open'); });
$('dd-search-input').addEventListener('input', function() { buildList(this.value); });
document.addEventListener('mousedown', e => { if (!$('ticker-wrap').contains(e.target)) closeDropdown(); });

// â”€â”€ Countdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const REFRESH_SECS = 60;
let countdown = REFRESH_SECS;
function updateCountdown() {
  $('countdown').textContent = `â± ${countdown}s`;
  $('countdown').classList.toggle('ticking', countdown <= 10);
  countdown--;
  if (countdown < 0) {
    countdown = REFRESH_SECS;
    if ($('chart-img').style.display !== 'none') loadAll(true);
  }
}
setInterval(updateCountdown, 1000);

// â”€â”€ Status / loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(msg, color = '#8b949e') { $('status').textContent = msg; $('status').style.color = color; }
function showLoading(msg = 'Loadingâ€¦') { $('loading-msg').textContent = msg; $('loading-overlay').style.display = 'flex'; }
function hideLoading() { $('loading-overlay').style.display = 'none'; }
function fmt(v, d = 2) { return (v === null || v === undefined) ? 'â€”' : Number(v).toFixed(d); }
function badge(active, tl, fl, tc, fc) { return `<span class="badge ${active ? tc : fc}">${active ? tl : fl}</span>`; }
function donBadge(v) {
  if (v === 1)  return `<span class="badge badge-green">BULL â–²</span>`;
  if (v === -1) return `<span class="badge badge-red">BEAR â–¼</span>`;
  return `<span class="badge badge-gray">FLAT â€”</span>`;
}

// â”€â”€ Populate sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function populateSidebar(s) {
  const closeEl = $('m-close');
  closeEl.textContent = fmt(s.close); closeEl.className = 'metric-value';
  if (s.vwap !== null && s.close !== null) closeEl.classList.add(s.close >= s.vwap ? 'val-up' : 'val-dn');

  $('m-vwap').textContent = fmt(s.vwap);

  const devEl = $('m-vwap-dev'); const devVal = s.vwap_dev_pct;
  devEl.textContent = devVal !== null ? `${fmt(devVal, 3)} %` : 'â€”';
  devEl.className = 'metric-value';
  if (devVal !== null) devEl.classList.add(devVal > 0 ? 'val-up' : 'val-dn');

  $('m-gravity').textContent = fmt(s.gravity);
  $('m-fib0').textContent    = s.fib0   !== null ? fmt(s.fib0)   : 'â€”';
  $('m-fib50').textContent   = s.fib50  !== null ? fmt(s.fib50)  : 'â€”';
  $('m-fib100').textContent  = s.fib100 !== null ? fmt(s.fib100) : 'â€”';
  $('m-hh').textContent  = s.hh_daily;
  $('m-ll').textContent  = s.ll_daily;
  $('m-hl').textContent  = s.daily_hl_diff !== null ? fmt(s.daily_hl_diff) : 'â€”';
  $('m-vol').textContent = s.daily_vol;
  $('m-z1').textContent  = s.zone_above_l1;
  $('m-z2').textContent  = s.zone_l1_l2;
  $('m-z3').textContent  = s.zone_l2_l3;
  $('m-z4').textContent  = s.zone_below_l3;
  $('m-don').innerHTML      = donBadge(s.don_main);
  $('m-allgreen').innerHTML = badge(s.all_green, 'YES âœ“', 'NO', 'badge-green', 'badge-gray');
  $('m-allred').innerHTML   = badge(s.all_red,   'YES âœ“', 'NO', 'badge-red',   'badge-gray');
  $('m-majfall').innerHTML  = badge(s.major_fall,          'ACTIVE âš ', 'NO', 'badge-red',    'badge-gray');
  $('m-brise').innerHTML    = badge(s.basic_rise,          'YES â–²',    'NO', 'badge-green',  'badge-gray');
  $('m-crise').innerHTML    = badge(s.confirmed_rise,      'YES â–²â–²',   'NO', 'badge-green',  'badge-gray');
  $('m-erise').innerHTML    = badge(s.explosive_rise,      'YES ğŸš€',   'NO', 'badge-blue',   'badge-gray');
  $('m-prise').innerHTML    = badge(s.parabolic_rise,      'YES âš¡',   'NO', 'badge-gold',   'badge-gray');
  $('m-escape').innerHTML   = badge(s.escape,              'YES â†‘',    'NO', 'badge-purple', 'badge-gray');
  $('m-crash').innerHTML    = badge(s.crash_risk,          'RISK âš ',   'NO', 'badge-red',    'badge-gray');
  $('m-g2r').innerHTML      = badge(s.signal_green_to_red, 'FLIP â†“',   'NO', 'badge-red',    'badge-gray');
  $('m-r2g').innerHTML      = badge(s.signal_red_to_green, 'FLIP â†‘',   'NO', 'badge-green',  'badge-gray');
  $('m-datetime').textContent = 'Updated: ' + (s.datetime || 'â€”');
}

// â”€â”€ Chart tab API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getTicker()   { return (selectedTicker || $('ticker-search').value.trim()).toUpperCase() || 'RELIANCE.NS'; }
function getRange()    { return $('range-sel').value; }
function getInterval() { return $('interval-sel').value; }
function getMinVol()   { return $('min-vol-sel').value; }

async function loadScreener() {
  const res  = await fetch(`/screener/${getTicker()}?range=${getRange()}&interval=${getInterval()}`);
  const json = await res.json();
  if (json.error) throw new Error(json.error);
  populateSidebar(json.summary);
  return json;
}

async function loadChart() {
  const url = `/chart/${getTicker()}?range=${getRange()}&interval=${getInterval()}&min_vol=${getMinVol()}&_t=${Date.now()}`;
  showLoading('Generating chartâ€¦');
  try {
    const res = await fetch(url);
    if (!res.ok) { const j = await res.json().catch(() => ({})); throw new Error(j.error || `HTTP ${res.status}`); }
    const blob = await res.blob();
    const img  = $('chart-img');
    img.onload = () => { $('placeholder').style.display = 'none'; img.style.display = 'block'; };
    img.src = URL.createObjectURL(blob);
    setStatus(`âœ“ ${getTicker()} â€” chart ready`, '#26a641');
  } catch(e) {
    setStatus('Chart error: ' + e.message, '#f85149');
  } finally { hideLoading(); }
}

async function loadAll(silent = false) {
  const ticker = getTicker();
  if (!silent) {
    showLoading('Fetching dataâ€¦'); setStatus('Loadingâ€¦', '#8b949e');
    document.querySelectorAll('.metric-value').forEach(el => { el.textContent = 'â€”'; el.className = 'metric-value'; });
    $('m-datetime').textContent = 'â€”';
  }
  if (!silent) countdown = REFRESH_SECS;
  try {
    const [res] = await Promise.all([loadScreener(), loadChart()]);
    setStatus(`âœ“ ${ticker}  Â·  ${res.bars} bars`, '#26a641');
  } catch(e) { setStatus('Error: ' + e.message, '#f85149'); hideLoading(); }
}

$('ticker-search').addEventListener('keydown', e => { if (e.key === 'Enter') { closeDropdown(); loadAll(); } if (e.key === 'Escape') closeDropdown(); });

// â”€â”€ Scanner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sigTags(row, type) {
  const tags = [];
  if (type === 'buy') {
    if (row.signal_r2g)       tags.push('<span class="badge badge-green">Râ†’G</span>');
    if (row.explosive_rise)   tags.push('<span class="badge badge-blue">Explosive</span>');
    if (row.confirmed_rise)   tags.push('<span class="badge badge-green">Confirmed</span>');
    if (row.parabolic_rise)   tags.push('<span class="badge badge-gold">Parabolic</span>');
    if (row.all_green)        tags.push('<span class="badge badge-green">AllGreen</span>');
    if (row.escape)           tags.push('<span class="badge badge-purple">Escape</span>');
  } else {
    if (row.signal_g2r)       tags.push('<span class="badge badge-red">Gâ†’R</span>');
    if (row.major_fall)       tags.push('<span class="badge badge-red">MajFall</span>');
    if (row.crash_risk)       tags.push('<span class="badge badge-red">Crash</span>');
    if (row.all_red)          tags.push('<span class="badge badge-red">AllRed</span>');
  }
  return tags.length ? tags.join(' ') : '<span style="color:#8b949e">â€”</span>';
}

function scoreBar(score, max, type) {
  const pct = Math.min(100, (score / max) * 100);
  return `${score} <span class="score-bar ${type}" style="width:${pct * 0.7}px"></span>`;
}

function renderScanTable(tbody, rows, type) {
  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#8b949e;padding:20px">No results</td></tr>`;
    return;
  }
  const maxScore = Math.max(...rows.map(r => type === 'buy' ? r.buy_score : r.sell_score), 1);
  tbody.innerHTML = rows.map((r, i) => {
    const score    = type === 'buy' ? r.buy_score : r.sell_score;
    const sigTime  = type === 'buy' ? r.buy_signal_time : r.sell_signal_time;
    const timeStr  = sigTime
      ? `<span style="color:#ffd700;font-weight:700">â° ${sigTime}</span>`
      : '<span style="color:#8b949e">â€”</span>';
    const devVal = r.vwap_dev_pct;
    const devStr = devVal !== null && devVal !== undefined
      ? `<span style="color:${devVal > 0 ? '#26a641' : '#f85149'}">${Number(devVal).toFixed(2)}%</span>`
      : 'â€”';
    const sym = r.ticker.replace('.NS', '');
    return `<tr onclick="jumpToChart('${r.ticker}')">
      <td style="color:#8b949e">${i + 1}</td>
      <td style="font-weight:700;color:#c9d1d9">${sym}</td>
      <td>${r.close !== null ? Number(r.close).toFixed(2) : 'â€”'}</td>
      <td>${devStr}</td>
      <td style="color:#ffa657">${r.daily_vol || 'â€”'}</td>
      <td>${sigTags(r, type)}</td>
      <td>${timeStr}</td>
      <td>${scoreBar(score, maxScore, type)}</td>
    </tr>`;
  }).join('');
}

function jumpToChart(ticker) {
  selectTicker(ticker);
  switchTab('chart');
  loadAll();
}

async function runScanner() {
  const interval = $('scan-interval-sel').value;
  const topN     = $('scan-topn-sel').value;

  $('scan-status-inline').textContent = 'Scanningâ€¦';
  $('scan-progress-wrap').style.display = 'block';
  $('scan-progress-bar').style.width = '10%';
  $('scan-status').textContent = `â³ Scanning ${SYMBOLS.length} symbolsâ€¦`;
  $('buy-tbody').innerHTML  = `<tr><td colspan="8" style="text-align:center;color:#8b949e;padding:24px"><div class="spinner" style="margin:0 auto"></div></td></tr>`;
  $('sell-tbody').innerHTML = `<tr><td colspan="8" style="text-align:center;color:#8b949e;padding:24px"><div class="spinner" style="margin:0 auto"></div></td></tr>`;

  // Animate progress
  let prog = 10;
  const progInterval = setInterval(() => {
    prog = Math.min(prog + 3, 90);
    $('scan-progress-bar').style.width = prog + '%';
  }, 800);

  try {
    const t0  = Date.now();
    const res = await fetch(`/scan?interval=${interval}&top_n=${topN}`);
    const data = await res.json();
    clearInterval(progInterval);
    $('scan-progress-bar').style.width = '100%';
    setTimeout(() => { $('scan-progress-wrap').style.display = 'none'; $('scan-progress-bar').style.width = '0%'; }, 600);

    if (data.error) throw new Error(data.error);

    renderScanTable($('buy-tbody'),  data.top_buy,  'buy');
    renderScanTable($('sell-tbody'), data.top_sell, 'sell');

    $('buy-count').textContent  = `Top ${data.top_buy.length}`;
    $('sell-count').textContent = `Top ${data.top_sell.length}`;

    const elapsed = ((Date.now() - t0) / 1000).toFixed(1);
    $('scan-status').textContent =
      `âœ“ Scanned ${data.scanned} symbols in ${elapsed}s  Â·  ${data.errors} errors  Â·  ${new Date().toLocaleTimeString('en-IN', {timeZone:'Asia/Kolkata'})} IST`;
    $('scan-status-inline').textContent = `Last scan: ${new Date().toLocaleTimeString('en-IN', {timeZone:'Asia/Kolkata'})} IST`;
  } catch(e) {
    clearInterval(progInterval);
    $('scan-progress-wrap').style.display = 'none';
    $('scan-status').textContent = 'âœ— Scan failed: ' + e.message;
    $('scan-status-inline').textContent = 'Scan failed';
  }
}

buildList('');
</script>
</body>
</html>
