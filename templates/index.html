<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>NSE Screener</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: #0d1117; color: #c9d1d9;
    font-family: 'Segoe UI', system-ui, sans-serif; font-size: 13px;
    height: 100vh; display: flex; flex-direction: column; overflow: hidden;
  }

  /* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
  #topbar {
    display: flex; align-items: center; gap: 10px;
    padding: 8px 14px; background: #161b22;
    border-bottom: 1px solid #21262d; flex-shrink: 0; flex-wrap: wrap;
  }
  #topbar h1 { font-size: 15px; font-weight: 700; color: #58a6ff; white-space: nowrap; }

  /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
  #tab-bar {
    display: flex;
    background: #161b22; border-bottom: 1px solid #21262d; flex-shrink: 0;
  }
  .tab-btn {
    padding: 8px 22px; cursor: pointer; font-size: 13px; font-weight: 600;
    color: #8b949e; border: none; background: transparent;
    border-bottom: 3px solid transparent; transition: all .15s;
  }
  .tab-btn:hover { color: #c9d1d9; }
  .tab-btn.active { color: #58a6ff; border-bottom-color: #58a6ff; }

  /* ‚îÄ‚îÄ TAB PANELS ‚îÄ‚îÄ */
  .tab-panel { display: none; flex: 1; overflow: hidden; min-height: 0; }
  .tab-panel.active { display: flex; }

  /* ‚îÄ‚îÄ TICKER DROPDOWN ‚îÄ‚îÄ */
  .ticker-wrap { position: relative; width: 210px; flex-shrink: 0; }
  #ticker-search {
    width: 100%; padding: 5px 28px 5px 10px;
    background: #0d1117; border: 1px solid #30363d; border-radius: 6px;
    color: #c9d1d9; font-size: 13px; outline: none; cursor: pointer;
  }
  #ticker-search:focus { border-color: #58a6ff; }
  .ticker-arrow { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: #8b949e; pointer-events: none; font-size: 10px; }
  #ticker-dropdown {
    position: absolute; top: calc(100% + 4px); left: 0; right: 0;
    background: #161b22; border: 1px solid #30363d; border-radius: 6px;
    max-height: 280px; overflow-y: auto; z-index: 999; display: none;
    box-shadow: 0 8px 24px rgba(0,0,0,.6);
  }
  #ticker-dropdown.open { display: block; }
  #dd-search-input {
    width: 100%; padding: 6px 10px;
    background: #0d1117; border: none; border-bottom: 1px solid #30363d;
    color: #c9d1d9; font-size: 12px; outline: none;
  }
  .dd-item { padding: 6px 12px; cursor: pointer; font-size: 12px; color: #c9d1d9; white-space: nowrap; }
  .dd-item:hover, .dd-item.highlighted { background: #1f6feb; color: #fff; }

  select {
    padding: 5px 8px; background: #0d1117; border: 1px solid #30363d;
    border-radius: 6px; color: #c9d1d9; font-size: 13px; outline: none; cursor: pointer;
  }
  select:focus { border-color: #58a6ff; }

  .btn {
    padding: 5px 14px; border-radius: 6px; border: none;
    font-size: 13px; font-weight: 600; cursor: pointer; transition: opacity .15s; white-space: nowrap;
  }
  .btn:hover { opacity: .85; }
  .btn-blue  { background: #1f6feb; color: #fff; }
  .btn-gray  { background: #21262d; color: #c9d1d9; }
  .btn-green { background: #1a7a3a; color: #fff; }

  #countdown {
    font-size: 11px; color: #8b949e; padding: 3px 9px;
    border: 1px solid #30363d; border-radius: 12px;
    background: #0d1117; min-width: 72px; text-align: center; white-space: nowrap;
  }
  #countdown.ticking { color: #58a6ff; border-color: #1f6feb; }
  #status { margin-left: auto; font-size: 12px; color: #8b949e; white-space: nowrap; }

  /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
  #sidebar {
    width: 220px; min-width: 220px; background: #161b22;
    border-right: 1px solid #21262d; overflow-y: auto;
    padding: 10px 8px; display: flex; flex-direction: column; gap: 10px;
    flex-shrink: 0;
  }
  .section-title {
    font-size: 10px; font-weight: 700; letter-spacing: .08em;
    text-transform: uppercase; color: #8b949e;
    padding: 4px 4px 2px; border-bottom: 1px solid #21262d; margin-bottom: 2px;
  }
  .metric-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 3px 4px; border-radius: 4px;
  }
  .metric-row:hover { background: #1c2128; }
  .metric-label { color: #8b949e; font-size: 12px; }
  .metric-value { font-size: 12px; font-weight: 600; color: #c9d1d9; text-align: right; }

  .val-up     { color: #26a641 !important; }
  .val-dn     { color: #f85149 !important; }
  .val-gold   { color: #ffa657 !important; }
  .val-blue   { color: #58a6ff !important; }
  .val-purple { color: #d2a8ff !important; }

  .badge { display: inline-block; padding: 1px 7px; border-radius: 10px; font-size: 11px; font-weight: 700; }
  .badge-green  { background: #1a3a1a; color: #26a641; border: 1px solid #26a641; }
  .badge-red    { background: #3a1a1a; color: #f85149; border: 1px solid #f85149; }
  .badge-gray   { background: #1c2128; color: #8b949e; border: 1px solid #30363d; }
  .badge-gold   { background: #3a2a00; color: #ffa657; border: 1px solid #ffa657; }
  .badge-blue   { background: #0c2340; color: #58a6ff; border: 1px solid #58a6ff; }
  .badge-purple { background: #2a1a40; color: #d2a8ff; border: 1px solid #d2a8ff; }

  /* ‚îÄ‚îÄ CHART AREA ‚îÄ‚îÄ */
  #chart-area {
    flex: 1; overflow: hidden; display: flex;
    align-items: stretch; justify-content: stretch;
    background: #0d1117; position: relative;
  }
  #chart-canvas { display: block; }
  #placeholder { display: flex; flex-direction: column; align-items: center; gap: 12px; color: #8b949e; }
  #placeholder svg { opacity: .3; }
  #placeholder p { font-size: 14px; }
  #loading-overlay {
    position: absolute; inset: 0; background: rgba(13,17,23,.75);
    display: none; align-items: center; justify-content: center;
    flex-direction: column; gap: 12px; z-index: 10;
  }
  .spinner { width: 36px; height: 36px; border: 3px solid #21262d; border-top-color: #58a6ff; border-radius: 50%; animation: spin .7s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  #loading-overlay p { color: #8b949e; font-size: 13px; }

  /* ‚îÄ‚îÄ SCANNER TAB ‚îÄ‚îÄ */
  #scanner-panel { flex-direction: column; background: #0d1117; }
  #scanner-toolbar {
    display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
    padding: 10px 16px; background: #161b22; border-bottom: 1px solid #21262d; flex-shrink: 0;
  }
  #scanner-content {
    flex: 1; overflow-y: auto; padding: 16px;
    display: grid; grid-template-columns: 1fr 1fr; gap: 16px; min-height: 0;
  }
  .scan-table-wrap { background: #161b22; border: 1px solid #21262d; border-radius: 8px; overflow: hidden; }
  .scan-table-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 14px; border-bottom: 1px solid #21262d;
  }
  .scan-table-title { font-size: 13px; font-weight: 700; }
  .scan-table-title.buy  { color: #26a641; }
  .scan-table-title.sell { color: #f85149; }
  .scan-badge { font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
  .scan-badge.buy  { background: #1a3a1a; color: #26a641; }
  .scan-badge.sell { background: #3a1a1a; color: #f85149; }
  table.scan-tbl { width: 100%; border-collapse: collapse; }
  table.scan-tbl th {
    text-align: left; padding: 7px 10px; font-size: 10px; font-weight: 700;
    letter-spacing: .06em; text-transform: uppercase; color: #8b949e;
    background: #0d1117; border-bottom: 1px solid #21262d; white-space: nowrap;
  }
  table.scan-tbl td { padding: 7px 10px; font-size: 12px; border-bottom: 1px solid #161b22; white-space: nowrap; }
  table.scan-tbl tr:last-child td { border-bottom: none; }
  table.scan-tbl tr:hover td { background: #1c2128; cursor: pointer; }
  .score-bar { display: inline-block; height: 6px; border-radius: 3px; vertical-align: middle; margin-left: 6px; }
  .score-bar.buy  { background: #26a641; }
  .score-bar.sell { background: #f85149; }
  #scan-status { padding: 6px 16px; font-size: 11px; color: #8b949e; background: #161b22; border-top: 1px solid #21262d; flex-shrink: 0; }
  #scan-progress-wrap { width: 260px; height: 6px; background: #21262d; border-radius: 3px; overflow: hidden; }
  #scan-progress-bar { height: 100%; width: 0%; background: #1f6feb; transition: width .2s; }

  /* ‚îÄ‚îÄ REPLAY TAB ‚îÄ‚îÄ */
  #replay-panel { flex-direction: column; background: #0d1117; }

  #replay-toolbar {
    display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
    padding: 8px 14px; background: #161b22; border-bottom: 1px solid #21262d;
    flex-shrink: 0;
  }

  .rpl-btn {
    padding: 5px 13px; border-radius: 6px; border: none;
    font-size: 13px; font-weight: 700; cursor: pointer; transition: all .15s;
    white-space: nowrap;
  }
  .rpl-btn:disabled { opacity: .3; cursor: not-allowed; }
  #rpl-load-btn  { background: #1f6feb; color: #fff; }
  #rpl-play-btn  { background: #1a7a3a; color: #fff; min-width: 84px; }
  #rpl-stop-btn  { background: #6e2323; color: #fff; }
  #rpl-reset-btn { background: #21262d; color: #c9d1d9; }

  #rpl-speed-sel { min-width: 100px; }

  #rpl-time-label { font-size: 14px; font-weight: 700; color: #ffd700; min-width: 54px; text-align: center; }
  #rpl-candle-label { font-size: 11px; color: #8b949e; white-space: nowrap; }

  #rpl-progress-wrap {
    flex: 1; min-width: 80px; height: 8px; background: #21262d; border-radius: 4px;
    overflow: hidden; cursor: pointer; position: relative;
  }
  #rpl-progress-bar { height: 100%; width: 0%; background: #1f6feb; pointer-events: none; }

  #replay-body {
    flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; position: relative;
  }
  #rpl-canvas { display: block; width: 100%; height: 100%; cursor: crosshair; }

  #rpl-info-bar {
    position: absolute; top: 6px; left: 68px;
    display: flex; gap: 12px; pointer-events: none; font-size: 11px;
  }

  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 3px; }
</style>
</head>
<body>

<!-- TOP BAR -->
<div id="topbar">
  <h1>üìà NSE Screener</h1>
  <div class="ticker-wrap" id="ticker-wrap">
    <input id="ticker-search" type="text" placeholder="Search symbol‚Ä¶" autocomplete="off" value="RELIANCE.NS"/>
    <span class="ticker-arrow">‚ñº</span>
    <div id="ticker-dropdown">
      <input id="dd-search-input" type="text" placeholder="Filter‚Ä¶" autocomplete="off"/>
      <div id="dd-list"></div>
    </div>
  </div>
  <select id="range-sel">
    <option value="1d" selected>1 Day</option>
    <option value="5d">5 Days</option>
    <option value="1mo">1 Month</option>
  </select>
  <select id="interval-sel">
    <option value="1m" selected>1 min</option>
    <option value="5m">5 min</option>
    <option value="15m">15 min</option>
  </select>
  <select id="min-vol-sel" title="Min Volume threshold">
    <option value="5000000">Vol ‚â• 5M</option>
    <option value="6000000" selected>Vol ‚â• 6M</option>
    <option value="7000000">Vol ‚â• 7M</option>
    <option value="8000000">Vol ‚â• 8M</option>
    <option value="9000000">Vol ‚â• 9M</option>
    <option value="10000000">Vol ‚â• 10M</option>
  </select>
  <button class="btn btn-blue" id="btn-load" onclick="loadAll()">Load</button>
  <button class="btn btn-gray" onclick="loadChart()">Chart Only</button>
  <button class="btn btn-gray" onclick="CCHART.resetZoom()" title="Reset chart zoom to full view">üîç Full</button>
  <span id="countdown" style="cursor:pointer" title="Click to pause/resume auto-refresh" onclick="toggleAutoRefresh()">‚è± 60s</span>
  <button class="btn btn-gray" id="ar-btn" onclick="toggleAutoRefresh()" title="Toggle auto-refresh" style="padding:4px 10px;font-size:12px;">‚è∏ Auto</button>
  <span id="status">‚Äî</span>
</div>

<!-- TAB BAR -->
<div id="tab-bar">
  <button class="tab-btn active" data-tab="chart">üìä Chart</button>
  <button class="tab-btn"       data-tab="scanner">üîç Scanner</button>
  <button class="tab-btn"       data-tab="replay">‚ñ∂ Replay</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHART TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="chart-panel" class="tab-panel active">
  <div id="sidebar">
    <div>
      <div class="section-title">Price &amp; VWAP</div>
      <div class="metric-row"><span class="metric-label">Close</span><span class="metric-value" id="m-close">‚Äî</span></div>
      <div class="metric-row"><span class="metric-label">VWAP</span><span class="metric-value" id="m-vwap">‚Äî</span></div>
      <div class="metric-row"><span class="metric-label">VWAP Dev %</span><span class="metric-value" id="m-vwap-dev">‚Äî</span></div>
      <div class="metric-row"><span class="metric-label">Gravity (CoG)</span><span class="metric-value val-purple" id="m-gravity">‚Äî</span></div>
    </div>
    <div>
      <div class="section-title">ORB Levels</div>
      <div class="metric-row"><span class="metric-label">ORB 0% (High)</span><span class="metric-value val-up" id="m-fib0">‚Äî</span></div>
      <div class="metric-row"><span class="metric-label">ORB 50% (Mid)</span><span class="metric-value val-blue" id="m-fib50">‚Äî</span></div>
      <div class="metric-row"><span class="metric-label">ORB 100% (Low)</span><span class="metric-value val-dn" id="m-fib100">‚Äî</span></div>
    </div>
    <div>
      <div class="section-title">Daily Stats</div>
      <div class="metric-row"><span class="metric-label">Higher Highs</span><span class="metric-value val-up" id="m-hh">‚Äî</span></div>
      <div class="metric-row"><span class="metric-label">Lower Lows</span><span class="metric-value val-dn" id="m-ll">‚Äî</span></div>
      <div class="metric-row"><span class="metric-label">H-L Range</span><span class="metric-value" id="m-hl">‚Äî</span></div>
      <div class="metric-row"><span class="metric-label">Cum. Volume</span><span class="metric-value val-gold" id="m-vol">‚Äî</span></div>
    </div>
    <div>
      <div class="section-title">Zone Bar Counts</div>
      <div class="metric-row"><span class="metric-label">Above L1</span><span class="metric-value val-up" id="m-z1">‚Äî</span></div>
      <div class="metric-row"><span class="metric-label">L1 ‚Üí L2</span><span class="metric-value" id="m-z2">‚Äî</span></div>
      <div class="metric-row"><span class="metric-label">L2 ‚Üí L3</span><span class="metric-value" id="m-z3">‚Äî</span></div>
      <div class="metric-row"><span class="metric-label">Below L3</span><span class="metric-value val-dn" id="m-z4">‚Äî</span></div>
    </div>
    <div>
      <div class="section-title">Donchian Trend</div>
      <div class="metric-row"><span class="metric-label">Main Trend</span><span class="metric-value" id="m-don">‚Äî</span></div>
      <div class="metric-row"><span class="metric-label">All Green</span><span class="metric-value" id="m-allgreen">‚Äî</span></div>
      <div class="metric-row"><span class="metric-label">All Red</span><span class="metric-value" id="m-allred">‚Äî</span></div>
    </div>
    <div>
      <div class="section-title">Signals</div>
      <div class="metric-row"><span class="metric-label">Major Fall</span><span class="metric-value" id="m-majfall">‚Äî</span></div>
      <div class="metric-row"><span class="metric-label">Basic Rise</span><span class="metric-value" id="m-brise">‚Äî</span></div>
      <div class="metric-row"><span class="metric-label">Confirmed Rise</span><span class="metric-value" id="m-crise">‚Äî</span></div>
      <div class="metric-row"><span class="metric-label">Explosive Rise</span><span class="metric-value" id="m-erise">‚Äî</span></div>
      <div class="metric-row"><span class="metric-label">Parabolic Rise</span><span class="metric-value" id="m-prise">‚Äî</span></div>
      <div class="metric-row"><span class="metric-label">Escape Velocity</span><span class="metric-value" id="m-escape">‚Äî</span></div>
      <div class="metric-row"><span class="metric-label">Crash Risk</span><span class="metric-value" id="m-crash">‚Äî</span></div>
      <div class="metric-row"><span class="metric-label">G ‚Üí R Flip</span><span class="metric-value" id="m-g2r">‚Äî</span></div>
      <div class="metric-row"><span class="metric-label">R ‚Üí G Flip</span><span class="metric-value" id="m-r2g">‚Äî</span></div>
    </div>
    <div style="padding:4px;color:#8b949e;font-size:11px;" id="m-datetime">‚Äî</div>
  </div>

  <div id="chart-area">
    <div id="loading-overlay">
      <div class="spinner"></div>
      <p id="loading-msg">Loading‚Ä¶</p>
    </div>
    <div id="placeholder">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#58a6ff" stroke-width="1.5">
        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
      </svg>
      <p>Select a symbol and press <strong>Load</strong></p>
    </div>
    <canvas id="chart-canvas" style="display:none;width:100%;height:100%;cursor:crosshair;"></canvas>
    <div id="chart-zoom-hint" style="display:none;position:absolute;bottom:8px;right:10px;font-size:10px;color:#556070;pointer-events:none;background:rgba(13,17,23,0.75);padding:3px 8px;border-radius:4px;">
      scroll=zoom ¬∑ drag=pan ¬∑ dbl-click=reset
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCANNER TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="scanner-panel" class="tab-panel">
  <div id="scanner-toolbar">
    <select id="scan-interval-sel">
      <option value="1m" selected>1 min</option>
      <option value="5m">5 min</option>
      <option value="15m">15 min</option>
    </select>
    <select id="scan-topn-sel">
      <option value="5">Top 5</option>
      <option value="10" selected>Top 10</option>
      <option value="15">Top 15</option>
      <option value="20">Top 20</option>
    </select>
    <button class="btn btn-green" onclick="runScanner()">‚ñ∂ Run Scanner</button>
    <div id="scan-progress-wrap" style="display:none"><div id="scan-progress-bar"></div></div>
    <span id="scan-status-inline" style="font-size:12px;color:#8b949e;">Scan all 93 symbols to find top Buy &amp; Sell setups</span>
  </div>

  <div id="scanner-content">
    <div class="scan-table-wrap">
      <div class="scan-table-header">
        <span class="scan-table-title buy">üü¢ Top Buy Setups</span>
        <span class="scan-badge buy" id="buy-count">‚Äî</span>
      </div>
      <table class="scan-tbl">
        <thead><tr><th>#</th><th>Symbol</th><th>Close</th><th>VWAP Dev%</th><th>Volume</th><th>Signals</th><th>Signal Time</th><th>Score</th></tr></thead>
        <tbody id="buy-tbody"><tr><td colspan="8" style="text-align:center;color:#8b949e;padding:24px">Press Run Scanner</td></tr></tbody>
      </table>
    </div>
    <div class="scan-table-wrap">
      <div class="scan-table-header">
        <span class="scan-table-title sell">üî¥ Top Sell Setups</span>
        <span class="scan-badge sell" id="sell-count">‚Äî</span>
      </div>
      <table class="scan-tbl">
        <thead><tr><th>#</th><th>Symbol</th><th>Close</th><th>VWAP Dev%</th><th>Volume</th><th>Signals</th><th>Signal Time</th><th>Score</th></tr></thead>
        <tbody id="sell-tbody"><tr><td colspan="8" style="text-align:center;color:#8b949e;padding:24px">Press Run Scanner</td></tr></tbody>
      </table>
    </div>
  </div>
  <div id="scan-status">Ready ‚Äî press Run Scanner to begin</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê REPLAY TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="replay-panel" class="tab-panel">

  <div id="replay-toolbar">
    <button class="rpl-btn" id="rpl-load-btn"  onclick="rplLoad()">üì• Load Data</button>
    <button class="rpl-btn" id="rpl-play-btn"  onclick="rplPlayPause()" disabled>‚ñ∂ Play</button>
    <button class="rpl-btn" id="rpl-stop-btn"  onclick="rplStop()"      disabled>‚èπ Stop</button>
    <button class="rpl-btn" id="rpl-reset-btn" onclick="rplReset()"     disabled>‚èÆ Reset</button>
    <button class="rpl-btn" id="rpl-zoom-btn"  onclick="RPL.resetZoom()" style="background:#21262d;color:#c9d1d9;">üîç Full</button>
    <label style="font-size:12px;color:#8b949e;">Speed</label>
    <select id="rpl-speed-sel">
      <option value="800">0.5√ó  slow</option>
      <option value="400" selected>1√ó  normal</option>
      <option value="200">2√ó  fast</option>
      <option value="80">5√ó  faster</option>
      <option value="30">10√ó ultra</option>
      <option value="5">50√ó turbo</option>
    </select>
    <span id="rpl-time-label">--:--</span>
    <div id="rpl-progress-wrap" title="Click to seek">
      <div id="rpl-progress-bar"></div>
    </div>
    <span id="rpl-candle-label">0 / 0</span>
  </div>

  <div id="replay-body">
    <canvas id="rpl-canvas"></canvas>
    <div id="rpl-info-bar">
      <span id="rpl-ohlcv" style="color:#c9d1d9;font-size:11px;"></span>
    </div>
  </div>

</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STOCK SYMBOLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SYMBOLS = [
  "ATGL.NS","NYKAA.NS","DMART.NS","BANKBARODA.NS","PGHH.NS","LTIM.NS",
  "HDFCAMC.NS","BANDHANBNK.NS","VEDL.NS","ADANIGREEN.NS","AMBUJACEM.NS",
  "PIDILITIND.NS","ICICIGI.NS","ICICIPRULI.NS","INDIGO.NS","GAIL.NS",
  "IOC.NS","MOTHERSON.NS","GLAND.NS","BAJAJHLDNG.NS","GODREJCP.NS",
  "DLF.NS","MARICO.NS","NAUKRI.NS","ACC.NS","HAVELLS.NS","HAL.NS",
  "MPHASIS.NS","LICI.NS","TORNTPHARM.NS","BEL.NS","PIIND.NS","IRCTC.NS",
  "COLPAL.NS","INDUSTOWER.NS","SBICARD.NS","BIOCON.NS","BERGEPAINT.NS",
  "TATAPOWER.NS","SIEMENS.NS","BOSCHLTD.NS","CHOLAFIN.NS","SRF.NS",
  "DABUR.NS","PAYTM.NS","MUTHOOTFIN.NS","BHARTIARTL.NS","EICHERMOT.NS",
  "SBIN.NS","AXISBANK.NS","TATASTEEL.NS","SBILIFE.NS","ADANIPORTS.NS",
  "HINDALCO.NS","JSWSTEEL.NS","ONGC.NS","ICICIBANK.NS","BPCL.NS",
  "INDUSINDBK.NS","HCLTECH.NS","SUNPHARMA.NS","WIPRO.NS","HEROMOTOCO.NS",
  "M&M.NS","INFY.NS","BAJFINANCE.NS","ADANIENT.NS","GRASIM.NS","TCS.NS",
  "HDFCLIFE.NS","ITC.NS","MARUTI.NS","UPL.NS","DRREDDY.NS","NTPC.NS",
  "RELIANCE.NS","CIPLA.NS","KOTAKBANK.NS","BAJAJFINSV.NS","HINDUNILVR.NS",
  "ASIANPAINT.NS","TECHM.NS","NESTLEIND.NS","POWERGRID.NS","LT.NS",
  "BAJAJ-AUTO.NS","BRITANNIA.NS","TATACONSUM.NS","COALINDIA.NS",
  "ULTRACEMCO.NS","DIVISLAB.NS","TITAN.NS","APOLLOHOSP.NS","ALOKINS.NS","MANAPPURAM.NS"
].sort();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const $ = id => document.getElementById(id);
function fmt(v, d=2){ return (v==null)?'‚Äî':Number(v).toFixed(d); }
function badge(on, tl, fl, tc, fc){ return `<span class="badge ${on?tc:fc}">${on?tl:fl}</span>`; }
function donBadge(v){
  if(v===1)  return `<span class="badge badge-green">BULL ‚ñ≤</span>`;
  if(v===-1) return `<span class="badge badge-red">BEAR ‚ñº</span>`;
  return `<span class="badge badge-gray">FLAT ‚Äî</span>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB SWITCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.tab === name);
  });
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  const panel = document.getElementById(name + '-panel');
  if (panel) {
    panel.classList.add('active');
    if (name === 'replay') {
      // Double rAF: wait until panel is fully painted and has real pixel dimensions
      requestAnimationFrame(() => requestAnimationFrame(() => {
        RPL.resize();
        RPL.draw();
      }));
    }
  }
}

document.querySelectorAll('.tab-btn').forEach(b => {
  b.addEventListener('click', () => switchTab(b.dataset.tab));
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TICKER DROPDOWN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedTicker = 'RELIANCE.NS';

function buildList(filter='') {
  const list = $('dd-list'); list.innerHTML = '';
  const q = filter.toUpperCase();
  SYMBOLS.filter(s => s.includes(q)).forEach(sym => {
    const d = document.createElement('div');
    d.className = 'dd-item' + (sym===selectedTicker?' highlighted':'');
    d.textContent = sym;
    d.addEventListener('mousedown', () => selectTicker(sym));
    list.appendChild(d);
  });
}
function selectTicker(sym){ selectedTicker=sym; $('ticker-search').value=sym; closeDD(); }
function openDD(){ $('dd-search-input').value=''; buildList(''); $('ticker-dropdown').classList.add('open'); $('dd-search-input').focus(); }
function closeDD(){ $('ticker-dropdown').classList.remove('open'); }

$('ticker-search').addEventListener('focus', openDD);
$('ticker-search').addEventListener('input', function(){ selectedTicker=this.value.toUpperCase(); buildList(this.value); $('ticker-dropdown').classList.add('open'); });
$('dd-search-input').addEventListener('input', function(){ buildList(this.value); });
document.addEventListener('mousedown', e => { if(!$('ticker-wrap').contains(e.target)) closeDD(); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COUNTDOWN AUTO-REFRESH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const REFRESH_SECS = 60;
let countdown = REFRESH_SECS;
let autoRefreshOn = true;

setInterval(() => {
  if (!autoRefreshOn) return;
  $('countdown').textContent = `‚è± ${countdown}s`;
  $('countdown').classList.toggle('ticking', countdown <= 10);
  if (--countdown < 0) {
    countdown = REFRESH_SECS;
    if ($('chart-img').style.display !== 'none') loadAll(true);
  }
}, 1000);

function toggleAutoRefresh() {
  autoRefreshOn = !autoRefreshOn;
  const btn = $('ar-btn');
  if (autoRefreshOn) {
    countdown = REFRESH_SECS;
    btn.textContent = '‚è∏ Auto';
    btn.style.color = '';
    btn.style.borderColor = '';
    $('countdown').textContent = `‚è± ${countdown}s`;
    $('countdown').classList.remove('ticking');
  } else {
    btn.textContent = '‚ñ∂ Auto';
    btn.style.color = '#f85149';
    btn.style.borderColor = '#f85149';
    $('countdown').textContent = '‚è± OFF';
    $('countdown').classList.remove('ticking');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHART TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setStatus(msg, col='#8b949e'){ $('status').textContent=msg; $('status').style.color=col; }
function showLoading(msg='Loading‚Ä¶'){ $('loading-msg').textContent=msg; $('loading-overlay').style.display='flex'; }
function hideLoading(){ $('loading-overlay').style.display='none'; }

function getTicker()  { return selectedTicker || 'RELIANCE.NS'; }
function getRange()   { return $('range-sel').value; }
function getInterval(){ return $('interval-sel').value; }
function getMinVol()  { return $('min-vol-sel').value; }

function populateSidebar(s){
  const ce=$('m-close'); ce.textContent=fmt(s.close); ce.className='metric-value';
  if(s.vwap!=null && s.close!=null) ce.classList.add(s.close>=s.vwap?'val-up':'val-dn');
  $('m-vwap').textContent=fmt(s.vwap);
  const de=$('m-vwap-dev'), dv=s.vwap_dev_pct;
  de.textContent=dv!=null?`${fmt(dv,3)} %`:'‚Äî'; de.className='metric-value';
  if(dv!=null) de.classList.add(dv>0?'val-up':'val-dn');
  $('m-gravity').textContent=fmt(s.gravity);
  $('m-fib0').textContent=s.fib0!=null?fmt(s.fib0):'‚Äî';
  $('m-fib50').textContent=s.fib50!=null?fmt(s.fib50):'‚Äî';
  $('m-fib100').textContent=s.fib100!=null?fmt(s.fib100):'‚Äî';
  $('m-hh').textContent=s.hh_daily; $('m-ll').textContent=s.ll_daily;
  $('m-hl').textContent=s.daily_hl_diff!=null?fmt(s.daily_hl_diff):'‚Äî';
  $('m-vol').textContent=s.daily_vol;
  $('m-z1').textContent=s.zone_above_l1; $('m-z2').textContent=s.zone_l1_l2;
  $('m-z3').textContent=s.zone_l2_l3;    $('m-z4').textContent=s.zone_below_l3;
  $('m-don').innerHTML=donBadge(s.don_main);
  $('m-allgreen').innerHTML=badge(s.all_green,'YES ‚úì','NO','badge-green','badge-gray');
  $('m-allred').innerHTML=badge(s.all_red,'YES ‚úì','NO','badge-red','badge-gray');
  $('m-majfall').innerHTML=badge(s.major_fall,'ACTIVE ‚ö†','NO','badge-red','badge-gray');
  $('m-brise').innerHTML=badge(s.basic_rise,'YES ‚ñ≤','NO','badge-green','badge-gray');
  $('m-crise').innerHTML=badge(s.confirmed_rise,'YES ‚ñ≤‚ñ≤','NO','badge-green','badge-gray');
  $('m-erise').innerHTML=badge(s.explosive_rise,'YES üöÄ','NO','badge-blue','badge-gray');
  $('m-prise').innerHTML=badge(s.parabolic_rise,'YES ‚ö°','NO','badge-gold','badge-gray');
  $('m-escape').innerHTML=badge(s.escape,'YES ‚Üë','NO','badge-purple','badge-gray');
  $('m-crash').innerHTML=badge(s.crash_risk,'RISK ‚ö†','NO','badge-red','badge-gray');
  $('m-g2r').innerHTML=badge(s.signal_green_to_red,'FLIP ‚Üì','NO','badge-red','badge-gray');
  $('m-r2g').innerHTML=badge(s.signal_red_to_green,'FLIP ‚Üë','NO','badge-green','badge-gray');
  $('m-datetime').textContent='Updated: '+(s.datetime||'‚Äî');
}

async function loadScreener(){
  const res=await fetch(`/screener/${getTicker()}?range=${getRange()}&interval=${getInterval()}`);
  const j=await res.json(); if(j.error) throw new Error(j.error);
  populateSidebar(j.summary); return j;
}

async function loadChart(){
  showLoading('Building chart‚Ä¶');
  try {
    const res = await fetch(`/replay_data/${getTicker()}?interval=${getInterval()}`);
    const json = await res.json();
    if(json.error) throw new Error(json.error);
    $('placeholder').style.display = 'none';
    $('chart-canvas').style.display = 'block';
    $('chart-zoom-hint').style.display = 'block';
    CCHART.load(json.data || [], getTicker());
    setStatus(`‚úì ${getTicker()} ‚Äî ${(json.data||[]).length} bars`,'#26a641');
  } catch(e){ setStatus('Chart error: '+e.message,'#f85149'); }
  finally { hideLoading(); }
}

async function loadAll(silent=false){
  const t=getTicker();
  if(!silent){
    showLoading('Fetching data‚Ä¶'); setStatus('Loading‚Ä¶','#8b949e');
    document.querySelectorAll('.metric-value').forEach(el=>{el.textContent='‚Äî';el.className='metric-value';});
    $('m-datetime').textContent='‚Äî';
  }
  if(!silent) countdown=REFRESH_SECS;
  try {
    const[r]=await Promise.all([loadScreener(),loadChart()]);
    setStatus(`‚úì ${t}  ¬∑  ${r.bars} bars`,'#26a641');
  } catch(e){ setStatus('Error: '+e.message,'#f85149'); hideLoading(); }
}

$('ticker-search').addEventListener('keydown', e=>{
  if(e.key==='Enter'){closeDD();loadAll();}
  if(e.key==='Escape') closeDD();
});




// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CCHART ‚Äî Interactive canvas chart for the Chart tab
// Same 3-panel layout as RPL but shows all bars at once with
// scroll-to-zoom, drag-to-pan, dbl-click-to-reset.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CCHART = {
  candles   : [],
  _ticker   : '',
  zoomStart : 0,
  zoomEnd   : 0,
  _drag     : null,

  cv () { return document.getElementById('chart-canvas'); },
  ctx() { return this.cv().getContext('2d'); },

  resize(){
    const cv=this.cv(), area=document.getElementById('chart-area');
    const w=area.clientWidth, h=area.clientHeight;
    if(w>0&&h>0){ cv.width=w; cv.height=h; }
  },

  load(candles, ticker){
    this.candles   = candles;
    this._ticker   = (ticker||'').replace('.NS','');
    this.zoomStart = 0;
    this.zoomEnd   = 0;
    this.resize();
    this.draw();
  },

  // ‚îÄ‚îÄ zoom helpers (identical logic to RPL) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  wheelZoom(deltaY, mouseX){
    if(!this.candles.length) return;
    const total=this.candles.length;
    const zS=this.zoomStart, zE=this.zoomEnd||total, zLen=zE-zS;
    const factor=deltaY<0?0.80:1.25;
    const newLen=Math.round(Math.max(10, Math.min(total, zLen*factor)));
    const PL=68,PR=62;
    const chartW=this.cv().width-PL-PR;
    const frac=Math.max(0,Math.min(1,(mouseX-PL)/chartW));
    const anchor=Math.round(zS+frac*zLen);
    let ns=Math.round(anchor-frac*newLen), ne=ns+newLen;
    if(ns<0){ns=0;ne=newLen;}
    if(ne>total){ne=total;ns=Math.max(0,total-newLen);}
    this.zoomStart=ns; this.zoomEnd=ne; this.draw();
  },

  resetZoom(){
    this.zoomStart=0; this.zoomEnd=0; this.draw();
  },

  // ‚îÄ‚îÄ main draw ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  draw(){
    const cv=this.cv(), ctx=this.ctx();
    const W=cv.width, H=cv.height;
    if(!W||!H) return;

    const candles=this.candles;
    const total=candles.length;

    ctx.fillStyle='#0d1117'; ctx.fillRect(0,0,W,H);

    if(!total){
      ctx.fillStyle='#8b949e'; ctx.font='14px Segoe UI,sans-serif'; ctx.textAlign='center';
      ctx.fillText('üì• Load Data to begin',W/2,H/2); ctx.textAlign='left'; return;
    }

    // ‚îÄ‚îÄ layout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const PL=68,PR=62,PT=30,PB=28;
    const innerH=H-PT-PB;
    const pH=Math.floor(innerH*0.60);
    const vH=Math.floor(innerH*0.25);
    const dH=innerH-pH-vH;
    const pT=PT, vT=PT+pH+1, dT=vT+vH+1;
    const chartW=W-PL-PR;

    // panel dividers
    ctx.strokeStyle='#21262d'; ctx.lineWidth=1;
    [[0,vT-1,W,vT-1],[0,dT-1,W,dT-1],[0,dT+dH+PB-1,W,dT+dH+PB-1]].forEach(([x1,y1,x2,y2])=>{
      ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
    });

    ctx.fillStyle='#556070'; ctx.font='8px Segoe UI,sans-serif'; ctx.textAlign='left';
    ctx.fillText('PRICE & VWAP',PL+4,pT+11);
    ctx.fillText('EXCESS VOL',  PL+4,vT+11);
    ctx.fillText('VWAP DEV %',  PL+4,dT+11);

    // ‚îÄ‚îÄ zoom window ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const zS=this.zoomStart, zE=this.zoomEnd||total, zLen=Math.max(1,zE-zS);
    const slotW=chartW/zLen;
    const candleW=Math.max(1.5,slotW*0.72);
    const hw=candleW/2;
    const toX=i=>PL+(i-zS+0.5)*slotW;
    const win=candles.slice(zS,zE);

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PANEL 1 ‚Äî PRICE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let hi=-Infinity,lo=Infinity;
    win.forEach(c=>{if(c.high>hi)hi=c.high;if(c.low<lo)lo=c.low;});
    if(!isFinite(hi)){hi=1;lo=0;}
    const pRange=hi-lo||hi*0.01||1, pPad=pRange*0.10;
    const pMin=lo-pPad, pMax=hi+pPad;
    const toY=v=>pT+(1-(v-pMin)/(pMax-pMin))*pH;

    // price grid
    ctx.font='9px Segoe UI,sans-serif'; ctx.fillStyle='#8b949e'; ctx.textAlign='right';
    for(let i=0;i<=5;i++){
      const f=i/5,yp=pT+f*pH,yv=pMax-f*(pMax-pMin);
      ctx.strokeStyle='#1c2128'; ctx.lineWidth=0.6;
      ctx.beginPath(); ctx.moveTo(PL,yp); ctx.lineTo(W-PR,yp); ctx.stroke();
      ctx.fillText(yv.toFixed(2),PL-3,yp+3);
    }
    ctx.textAlign='left';

    // ORB levels
    const orbBar=candles.find(c=>c.fib0!=null);
    if(orbBar){
      [{v:orbBar.fib0,col:'#26a641',lbl:'ORB 0%'},
       {v:orbBar.fib50,col:'#58a6ff',lbl:'ORB 50%'},
       {v:orbBar.fib100,col:'#f85149',lbl:'ORB 100%'}].forEach(({v,col,lbl})=>{
        if(v==null)return;
        const yp=toY(v);
        if(yp<pT-2||yp>pT+pH+2)return;
        ctx.strokeStyle=col; ctx.lineWidth=0.8; ctx.setLineDash([3,5]);
        ctx.beginPath(); ctx.moveTo(PL,yp); ctx.lineTo(W-PR,yp); ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle=col; ctx.font='8px Segoe UI,sans-serif';
        ctx.fillText(lbl,W-PR+4,yp-2);
        ctx.fillStyle='#c9d1d9'; ctx.font='bold 8px Segoe UI,sans-serif';
        ctx.fillText(v.toFixed(1),W-PR+4,yp+8);
      });
    }

    // VWAP ‚Äî cumulative from bar 0 for accuracy, draw only in window
    {
      const arr=[]; let cpv=0,cv2=0;
      candles.forEach(c=>{
        let v=c.vwap;
        if(v==null){const h3=(c.high+c.low+c.close)/3;cpv+=h3*c.volume;cv2+=c.volume;v=cv2?cpv/cv2:h3;}
        arr.push(v);
      });
      ctx.beginPath(); ctx.strokeStyle='#58a6ff'; ctx.lineWidth=1.8; let vs=false;
      win.forEach((c,wi)=>{const xp=toX(zS+wi),yp=toY(arr[zS+wi]);vs?ctx.lineTo(xp,yp):(ctx.moveTo(xp,yp),vs=true);});
      ctx.stroke();
    }

    // Gravity dashed white
    {
      let gs=false;
      ctx.beginPath(); ctx.strokeStyle='rgba(210,210,210,0.7)'; ctx.lineWidth=1.1; ctx.setLineDash([5,4]);
      win.forEach((c,wi)=>{if(c.gravity==null)return;const xp=toX(zS+wi),yp=toY(c.gravity);gs?ctx.lineTo(xp,yp):(ctx.moveTo(xp,yp),gs=true);});
      ctx.stroke(); ctx.setLineDash([]);
    }

    // Candles
    win.forEach((c,wi)=>{
      const xc=toX(zS+wi),bull=c.close>=c.open,col=bull?'#26a641':'#f85149';
      const yO=toY(c.open),yC=toY(c.close),yH=toY(c.high),yL=toY(c.low);
      ctx.strokeStyle=col; ctx.lineWidth=Math.max(0.8,candleW*0.15);
      ctx.beginPath(); ctx.moveTo(xc,yH); ctx.lineTo(xc,yL); ctx.stroke();
      ctx.fillStyle=col;
      ctx.fillRect(xc-hw,Math.min(yO,yC),candleW,Math.max(1,Math.abs(yC-yO)));
    });

    // Current price line + label box
    const last=win[win.length-1];
    const lastY=toY(last.close),bullL=last.close>=last.open,pcol=bullL?'#26a641':'#f85149';
    ctx.strokeStyle=pcol; ctx.lineWidth=0.8; ctx.setLineDash([4,3]);
    ctx.beginPath(); ctx.moveTo(PL,lastY); ctx.lineTo(W-PR,lastY); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle=pcol; ctx.fillRect(W-PR+2,lastY-7,46,14);
    ctx.fillStyle='#fff'; ctx.font='bold 9px Segoe UI,sans-serif'; ctx.textAlign='left';
    ctx.fillText(last.close.toFixed(2),W-PR+5,lastY+4);
    ctx.textAlign='right';

    // Signal markers
    const SIG=Math.max(5,candleW*2.0);
    win.forEach((c,wi)=>{
      const xc=toX(zS+wi);
      const buyY=toY(c.low)+SIG+2;
      if(c.vol_buy_signal){
        _drawMarker(ctx,xc,buyY,'‚ñ≤','#00e5ff',SIG*2.2,'bold');
        if(c.percent_diff!=null) _drawLabel(ctx,xc,buyY+SIG+4,'+'+c.percent_diff.toFixed(0)+'%','#00e5ff','#0d1117');
      } else if(c.signal_r2g)    { _drawMarker(ctx,xc,buyY,'‚ñ≤','#26a641',SIG*2,'bold'); }
        else if(c.parabolic_rise){ _drawMarker(ctx,xc,buyY,'‚ñ≤','#ffd700',SIG*1.8,'bold'); }
        else if(c.explosive_rise){ _drawMarker(ctx,xc,buyY,'‚ñ≤','#00e5ff',SIG*1.6,''); }
        else if(c.confirmed_rise){ _drawMarker(ctx,xc,buyY,'‚ñ≤','#26a641',SIG*1.4,''); }
        else if(c.basic_rise)    { _drawMarker(ctx,xc,buyY,'‚ñ≤','#b3f5b3',SIG*1.2,''); }
        else if(c.escape)        { _drawMarker(ctx,xc,buyY,'‚óÜ','#d2a8ff',SIG*1.4,'bold'); }
      const sellY=toY(c.high)-SIG-2;
      if(c.vol_sell_signal){
        _drawMarker(ctx,xc,sellY,'‚ñº','#ff9f00',SIG*2.2,'bold');
        if(c.percent_diff!=null) _drawLabel(ctx,xc,sellY-SIG-4,c.percent_diff.toFixed(0)+'%','#ff9f00','#0d1117');
      } else if(c.signal_g2r) { _drawMarker(ctx,xc,sellY,'‚ñº','#f85149',SIG*2,'bold'); }
        else if(c.crash_risk) { _drawMarker(ctx,xc,sellY,'‚ñº','#ff7b72',SIG*1.8,'bold'); }
        else if(c.major_fall) { _drawMarker(ctx,xc,sellY,'‚ñº','#ffa657',SIG*1.6,''); }
    });

    // Legend
    this._legend(ctx,PL+4,pT+4);

    // Title
    ctx.fillStyle='#c9d1d9'; ctx.font='bold 11px Segoe UI,sans-serif'; ctx.textAlign='center';
    const d0=candles[0].date.slice(0,10).split('-');
    const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const dateStr=d0[2]+' '+months[+d0[1]-1]+' '+d0[0];
    ctx.fillText('NSE ¬∑ '+this._ticker+' ¬∑ '+dateStr+' ¬∑ 09:15‚Äì15:30 IST ¬∑ 1-Min',W/2,pT-10);
    ctx.textAlign='left';

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PANEL 2 ‚Äî EXCESS COMBINED VOLUME
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const cvV=win.map(c=>c.combined_volume??0);
    const smV=win.map(c=>c.smoothed_volume??null);
    const allV=[...cvV,...smV.filter(v=>v!=null)];
    const vAbs=Math.max(...allV.map(Math.abs),1);
    const vYMn=-vAbs*1.12,vYMx=vAbs*1.12;
    const toVY=v=>vT+(1-(v-vYMn)/(vYMx-vYMn))*vH;
    const vZ=toVY(0);

    ctx.font='8px Segoe UI,sans-serif'; ctx.fillStyle='#8b949e'; ctx.textAlign='right';
    [-1,-0.5,0,0.5,1].forEach(f=>{
      const yv=vAbs*f,yp=toVY(yv);
      if(yp<vT||yp>vT+vH)return;
      ctx.strokeStyle='#1c2128'; ctx.lineWidth=0.5;
      ctx.beginPath(); ctx.moveTo(PL,yp); ctx.lineTo(W-PR,yp); ctx.stroke();
      const lb=Math.abs(yv)>=1000?(yv/1000).toFixed(0)+'k':yv.toFixed(0);
      ctx.fillText(lb,PL-3,yp+3);
    });
    ctx.textAlign='left';
    ctx.strokeStyle='#8b949e'; ctx.lineWidth=0.8;
    ctx.beginPath(); ctx.moveTo(PL,vZ); ctx.lineTo(W-PR,vZ); ctx.stroke();

    // no fill ‚Äî lines only

    // combined vol line ‚Äî GREEN
    ctx.beginPath(); ctx.strokeStyle='#26a641'; ctx.lineWidth=1.2;
    cvV.forEach((v,wi)=>{const xp=toX(zS+wi),yp=toVY(v);wi===0?ctx.moveTo(xp,yp):ctx.lineTo(xp,yp);});
    ctx.stroke();

    // smoothed vol line ‚Äî RED
    {let ss=false;
    ctx.beginPath(); ctx.strokeStyle='#f85149'; ctx.lineWidth=1.8;
    win.forEach((c,wi)=>{const v=c.smoothed_volume;if(v==null)return;const xp=toX(zS+wi),yp=toVY(v);ss?ctx.lineTo(xp,yp):(ctx.moveTo(xp,yp),ss=true);});
    ctx.stroke();}

    // vol buy/sell markers ‚Äî include time, pct, close price
    win.forEach((c,wi)=>{
      const xc=toX(zS+wi),yp=toVY(c.combined_volume??0);
      if(c.vol_buy_signal){
        _drawMarker(ctx,xc,yp-10,'‚ñ≤','#26a641',11,'bold');
        const lb=c.date.slice(11,16)
          +(c.percent_diff!=null?' +'+c.percent_diff.toFixed(0)+'%':'')
          +' ‚Çπ'+c.close.toFixed(1);
        _drawLabel(ctx,xc,yp-24,lb,'#26a641','#0d1117');
      }
      if(c.vol_sell_signal){
        _drawMarker(ctx,xc,yp+10,'‚ñº','#f85149',11,'bold');
        const lb=c.date.slice(11,16)
          +(c.percent_diff!=null?' '+c.percent_diff.toFixed(0)+'%':'')
          +' ‚Çπ'+c.close.toFixed(1);
        _drawLabel(ctx,xc,yp+24,lb,'#f85149','#0d1117');
      }
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PANEL 3 ‚Äî VWAP DEV %
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const devV=win.map(c=>c.vwap_dev??null).filter(v=>v!=null);
    const dAbs=Math.max(...devV.map(Math.abs),0.1);
    const dYMn=-dAbs*1.2,dYMx=dAbs*1.2;
    const toDY=v=>dT+(1-(v-dYMn)/(dYMx-dYMn))*dH;
    const dZ=toDY(0);

    ctx.font='8px Segoe UI,sans-serif'; ctx.fillStyle='#8b949e'; ctx.textAlign='right';
    [-1,-0.5,0,0.5,1].forEach(f=>{
      const yv=dAbs*f,yp=toDY(yv);
      if(yp<dT||yp>dT+dH)return;
      ctx.strokeStyle='#1c2128'; ctx.lineWidth=0.5;
      ctx.beginPath(); ctx.moveTo(PL,yp); ctx.lineTo(W-PR,yp); ctx.stroke();
      ctx.fillText(yv.toFixed(2)+'%',PL-3,yp+3);
    });
    ctx.textAlign='left';
    ctx.strokeStyle='#8b949e'; ctx.lineWidth=0.8;
    ctx.beginPath(); ctx.moveTo(PL,dZ); ctx.lineTo(W-PR,dZ); ctx.stroke();

    {
      const db=win.map((c,wi)=>({c,i:zS+wi})).filter(({c})=>c.vwap_dev!=null);
      if(db.length){
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(toX(db[0].i),dZ);
        db.forEach(({c,i})=>ctx.lineTo(toX(i),toDY(c.vwap_dev)));
        ctx.lineTo(toX(db[db.length-1].i),dZ);
        ctx.closePath(); ctx.clip();
        ctx.fillStyle='rgba(38,166,65,0.40)'; ctx.fillRect(PL,dT,chartW,Math.max(0,dZ-dT));
        ctx.fillStyle='rgba(248,81,73,0.40)'; ctx.fillRect(PL,dZ,chartW,dH);
        ctx.restore();
        let dvs=false;
        ctx.beginPath(); ctx.strokeStyle='#58a6ff'; ctx.lineWidth=1.2;
        db.forEach(({c,i})=>{const xp=toX(i),yp=toDY(c.vwap_dev);dvs?ctx.lineTo(xp,yp):(ctx.moveTo(xp,yp),dvs=true);});
        ctx.stroke();
      }
    }

    // ‚îÄ‚îÄ Time axis ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    this._timeAxis(ctx,W,PL,PR,pT,dT+dH,total,toX,zS,zE);
  },

  // ‚îÄ‚îÄ Legend ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  _legend(ctx,x,y){
    const items=[
      {col:'#58a6ff',lw:2,ls:null,lbl:'VWAP'},
      {col:'#d0d0d0',lw:1.1,ls:[4,3],lbl:'Gravity'},
      {col:'#26a641',lw:1,ls:[3,4],lbl:'ORB 0%'},
      {col:'#58a6ff',lw:1,ls:[3,4],lbl:'ORB 50%'},
      {col:'#f85149',lw:1,ls:[3,4],lbl:'ORB 100%'},
      {mrk:'‚ñº',col:'#f85149',lbl:'G‚ÜíR Flip'},
      {mrk:'‚ñ≤',col:'#26a641',lbl:'R‚ÜíG Flip'},
      {mrk:'‚ñ≤',col:'#00e5ff',lbl:'Vol Buy ‚â•+25%'},
      {mrk:'‚ñº',col:'#ff9f00',lbl:'Vol Sell ‚â§-25%'},
      {mrk:'‚óÜ',col:'#ff00ff',lbl:'Vol Surge'},
    ];
    const cols=2,rows=Math.ceil(items.length/cols);
    const iW=110,iH=13,boxW=cols*iW+8,boxH=rows*iH+8;
    ctx.fillStyle='rgba(22,27,34,0.85)';
    ctx.strokeStyle='#30363d'; ctx.lineWidth=0.8;
    ctx.fillRect(x,y,boxW,boxH); ctx.strokeRect(x,y,boxW,boxH);
    items.forEach((it,idx)=>{
      const col=idx%cols,row=Math.floor(idx/cols);
      const ix=x+6+col*iW,iy=y+6+row*iH;
      if(it.mrk){
        ctx.fillStyle=it.col; ctx.font='bold 9px Segoe UI,sans-serif';
        ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.fillText(it.mrk,ix+5,iy+5);
      } else {
        ctx.save();
        if(it.ls) ctx.setLineDash(it.ls);
        ctx.strokeStyle=it.col; ctx.lineWidth=it.lw;
        ctx.beginPath(); ctx.moveTo(ix,iy+5); ctx.lineTo(ix+10,iy+5); ctx.stroke();
        ctx.setLineDash([]); ctx.restore();
      }
      ctx.fillStyle='#c9d1d9'; ctx.font='8px Segoe UI,sans-serif';
      ctx.textAlign='left'; ctx.textBaseline='alphabetic';
      ctx.fillText(it.lbl,ix+13,iy+9);
    });
    ctx.textAlign='left'; ctx.textBaseline='alphabetic';
  },

  // ‚îÄ‚îÄ Time axis ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  _timeAxis(ctx,W,PL,PR,panelTop,panelBot,total,toX,zS,zE){
    const MARKS=['09:15','09:30','10:00','10:30','11:00','11:30',
                 '12:00','12:30','13:00','13:30','14:00','14:30','15:00','15:30'];
    const _zE=zE||total;
    ctx.font='9px Segoe UI,sans-serif'; ctx.fillStyle='#8b949e'; ctx.textAlign='center';
    MARKS.forEach(t=>{
      const idx=this.candles.findIndex(c=>c.date.slice(11,16)===t);
      if(idx>=0&&(idx<zS||idx>=_zE))return;
      let xp;
      if(idx>=0){xp=toX(idx);}
      else{const[hh,mm]=t.split(':').map(Number);xp=PL+(hh*60+mm-(9*60+15))*(W-PL-PR)/total+0.5;}
      if(xp<PL||xp>W-PR)return;
      ctx.strokeStyle='#21262d'; ctx.lineWidth=0.5; ctx.setLineDash([2,3]);
      ctx.beginPath(); ctx.moveTo(xp,panelTop); ctx.lineTo(xp,panelBot); ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillText(t,xp,panelBot+12);
    });
    ctx.textAlign='left';
  },

  // ‚îÄ‚îÄ Hover tooltip ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  onHover(mx){
    if(!this.candles.length)return;
    const PL=68,PR=62;
    const zS=this.zoomStart, zE=this.zoomEnd||this.candles.length;
    const slotW=(this.cv().width-PL-PR)/Math.max(1,zE-zS);
    const idx=zS+Math.floor((mx-PL)/slotW);
    if(idx<zS||idx>=Math.min(zE,this.candles.length))return;
    const c=this.candles[idx],b=c.close>=c.open;
    const sigs=[];
    if(c.vol_buy_signal)  sigs.push('<span style="color:#00e5ff;font-weight:700">VolBUY'+(c.percent_diff!=null?' +'+c.percent_diff.toFixed(0)+'%':'')+'</span>');
    if(c.vol_sell_signal) sigs.push('<span style="color:#ff9f00;font-weight:700">VolSELL'+(c.percent_diff!=null?' '+c.percent_diff.toFixed(0)+'%':'')+'</span>');
    if(c.signal_r2g)      sigs.push('<span style="color:#26a641">R‚ÜíG</span>');
    if(c.signal_g2r)      sigs.push('<span style="color:#f85149">G‚ÜíR</span>');
    document.getElementById('status').innerHTML=
      '<b style="color:#ffd700">'+c.date.slice(11,16)+'</b>  '+
      'O <b style="color:'+(b?'#26a641':'#f85149')+'">'+c.open.toFixed(2)+'</b>  '+
      'H <b style="color:#26a641">'+c.high.toFixed(2)+'</b>  '+
      'L <b style="color:#f85149">'+c.low.toFixed(2)+'</b>  '+
      'C <b style="color:'+(b?'#26a641':'#f85149')+'">'+c.close.toFixed(2)+'</b>  '+
      'Vol <b style="color:#ffa657">'+(c.volume/1e6).toFixed(2)+'M</b>'+
      (sigs.length?'  '+sigs.join(' '):'');
  },
};

// ‚îÄ‚îÄ Wire CCHART canvas events ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function(){
  const cv=document.getElementById('chart-canvas');

  cv.addEventListener('wheel',e=>{
    e.preventDefault();
    const r=cv.getBoundingClientRect();
    CCHART.wheelZoom(e.deltaY,e.clientX-r.left);
  },{passive:false});

  cv.addEventListener('mousedown',e=>{
    if(e.button!==0)return;
    const r=cv.getBoundingClientRect();
    const PL=68,PR=62;
    const zS=CCHART.zoomStart,zE=CCHART.zoomEnd||CCHART.candles.length;
    CCHART._drag={startX:e.clientX-r.left,startZS:zS,startZE:zE,
                  slotW:(cv.width-PL-PR)/Math.max(1,zE-zS)};
    cv.style.cursor='grabbing';
  });

  cv.addEventListener('mousemove',e=>{
    const r=cv.getBoundingClientRect();
    const mx=e.clientX-r.left;
    if(CCHART._drag){
      const d=CCHART._drag;
      const dBars=Math.round((d.startX-mx)/d.slotW);
      const zLen=d.startZE-d.startZS;
      const total=CCHART.candles.length;
      let ns=d.startZS+dBars,ne=d.startZE+dBars;
      if(ns<0){ns=0;ne=zLen;}
      if(ne>total){ne=total;ns=Math.max(0,total-zLen);}
      CCHART.zoomStart=ns; CCHART.zoomEnd=ne; CCHART.draw();
    } else {
      CCHART.onHover(mx);
    }
  });

  ['mouseup','mouseleave'].forEach(ev=>cv.addEventListener(ev,()=>{
    CCHART._drag=null; cv.style.cursor='crosshair';
  }));

  cv.addEventListener('dblclick',()=>CCHART.resetZoom());

  window.addEventListener('resize',()=>{
    if(cv.style.display!=='none'){ CCHART.resize(); CCHART.draw(); }
  });
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCANNER TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function sigTags(r,type){
  const t=[];
  if(type==='buy'){
    if(r.signal_r2g)     t.push('<span class="badge badge-green">R‚ÜíG</span>');
    if(r.explosive_rise) t.push('<span class="badge badge-blue">Explosive</span>');
    if(r.confirmed_rise) t.push('<span class="badge badge-green">Confirmed</span>');
    if(r.parabolic_rise) t.push('<span class="badge badge-gold">Parabolic</span>');
    if(r.all_green)      t.push('<span class="badge badge-green">AllGreen</span>');
    if(r.escape)         t.push('<span class="badge badge-purple">Escape</span>');
  } else {
    if(r.signal_g2r)  t.push('<span class="badge badge-red">G‚ÜíR</span>');
    if(r.major_fall)  t.push('<span class="badge badge-red">MajFall</span>');
    if(r.crash_risk)  t.push('<span class="badge badge-red">Crash</span>');
    if(r.all_red)     t.push('<span class="badge badge-red">AllRed</span>');
  }
  return t.length?t.join(' '):'<span style="color:#8b949e">‚Äî</span>';
}
function scoreBar(score,max,type){
  return `${score}<span class="score-bar ${type}" style="width:${Math.min(50,(score/max)*50)}px"></span>`;
}
function renderScanTable(tbody,rows,type){
  if(!rows.length){tbody.innerHTML=`<tr><td colspan="8" style="text-align:center;color:#8b949e;padding:20px">No results</td></tr>`;return;}
  const mx=Math.max(...rows.map(r=>type==='buy'?r.buy_score:r.sell_score),1);
  tbody.innerHTML=rows.map((r,i)=>{
    const score=type==='buy'?r.buy_score:r.sell_score;
    const st=type==='buy'?r.buy_signal_time:r.sell_signal_time;
    const tstr=st?`<span style="color:#ffd700;font-weight:700">‚è∞ ${st}</span>`:'<span style="color:#8b949e">‚Äî</span>';
    const dv=r.vwap_dev_pct;
    const ds=dv!=null?`<span style="color:${dv>0?'#26a641':'#f85149'}">${Number(dv).toFixed(2)}%</span>`:'‚Äî';
    return `<tr onclick="jumpToChart('${r.ticker}')">
      <td style="color:#8b949e">${i+1}</td>
      <td style="font-weight:700">${r.ticker.replace('.NS','')}</td>
      <td>${r.close!=null?Number(r.close).toFixed(2):'‚Äî'}</td>
      <td>${ds}</td>
      <td style="color:#ffa657">${r.daily_vol||'‚Äî'}</td>
      <td>${sigTags(r,type)}</td>
      <td>${tstr}</td>
      <td>${scoreBar(score,mx,type)}</td>
    </tr>`;
  }).join('');
}
function jumpToChart(ticker){ selectTicker(ticker); switchTab('chart'); loadAll(); }

async function runScanner(){
  const interval=$('scan-interval-sel').value, topN=$('scan-topn-sel').value;
  $('scan-status-inline').textContent='Scanning‚Ä¶';
  $('scan-progress-wrap').style.display='block';
  $('scan-progress-bar').style.width='10%';
  $('scan-status').textContent=`‚è≥ Scanning ${SYMBOLS.length} symbols‚Ä¶`;
  $('buy-tbody').innerHTML=`<tr><td colspan="8" style="text-align:center;padding:24px"><div class="spinner" style="margin:0 auto"></div></td></tr>`;
  $('sell-tbody').innerHTML=`<tr><td colspan="8" style="text-align:center;padding:24px"><div class="spinner" style="margin:0 auto"></div></td></tr>`;
  let prog=10;
  const pi=setInterval(()=>{ prog=Math.min(prog+3,90); $('scan-progress-bar').style.width=prog+'%'; },800);
  try {
    const t0=Date.now();
    const res=await fetch(`/scan?interval=${interval}&top_n=${topN}`);
    const data=await res.json();
    clearInterval(pi);
    $('scan-progress-bar').style.width='100%';
    setTimeout(()=>{ $('scan-progress-wrap').style.display='none'; $('scan-progress-bar').style.width='0%'; },600);
    if(data.error) throw new Error(data.error);
    renderScanTable($('buy-tbody'),data.top_buy,'buy');
    renderScanTable($('sell-tbody'),data.top_sell,'sell');
    $('buy-count').textContent=`Top ${data.top_buy.length}`;
    $('sell-count').textContent=`Top ${data.top_sell.length}`;
    const el=((Date.now()-t0)/1000).toFixed(1);
    $('scan-status').textContent=`‚úì Scanned ${data.scanned} in ${el}s ¬∑ ${data.errors} errors ¬∑ ${new Date().toLocaleTimeString('en-IN',{timeZone:'Asia/Kolkata'})} IST`;
    $('scan-status-inline').textContent=`Last: ${new Date().toLocaleTimeString('en-IN',{timeZone:'Asia/Kolkata'})} IST`;
  } catch(e){ clearInterval(pi); $('scan-progress-wrap').style.display='none'; $('scan-status').textContent='‚úó '+e.message; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REPLAY ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const RPL = {
  candles : [],
  cursor  : 0,
  timer   : null,
  playing : false,
  _ticker : '',
  // zoom window: indices into candles[] that are visible
  zoomStart : 0,
  zoomEnd   : 0,    // 0 means "use full range"
  _drag     : null, // {startX, startZoomStart, startZoomEnd} while panning

  // ‚îÄ‚îÄ helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  cv ()  { return document.getElementById('rpl-canvas'); },
  ctx()  { return this.cv().getContext('2d'); },
  speed(){ return parseInt(document.getElementById('rpl-speed-sel').value, 10); },

  // ‚îÄ‚îÄ resize canvas to its container ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  resize(){
    const cv  = this.cv();
    const bod = document.getElementById('replay-body');
    const w   = bod.offsetWidth;
    const h   = bod.offsetHeight;
    if (w > 0 && h > 0) { cv.width = w; cv.height = h; }
  },

  // ‚îÄ‚îÄ load OHLCV + indicators from /replay_data/ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async load(ticker){
    // Use replay_data which returns per-bar indicator values (IST-filtered)
    const res  = await fetch('/replay_data/' + ticker + '?interval=1m');
    const json = await res.json();
    if (json.error) throw new Error(json.error);

    this.candles = json.data || [];
    this._ticker = ticker.replace('.NS','');
    if (!this.candles.length) throw new Error('No session candles');

    this.cursor   = 0;
    this.playing  = false;
    this.zoomStart = 0;
    this.zoomEnd   = 0;

    this.resize();
    this.draw();
    this.syncUI();
    return this.candles.length;
  },

  // ‚îÄ‚îÄ play / pause toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  playPause(){
    if (!this.candles.length) return;
    if (this.playing) {
      this.pause();
    } else {
      if (this.cursor >= this.candles.length) this.cursor = 0;
      this.playing = true;
      document.getElementById('rpl-play-btn').textContent = '‚è∏ Pause';
      document.getElementById('rpl-stop-btn').disabled    = false;
      this._tick();
    }
  },

  pause(){
    this.playing = false;
    clearTimeout(this.timer);
    document.getElementById('rpl-play-btn').textContent = '‚ñ∂ Play';
  },

  _tick(){
    if (!this.playing) return;
    if (this.cursor < this.candles.length) {
      this.cursor++;
      this.draw();
      this.syncUI();
      this.timer = setTimeout(() => this._tick(), this.speed());
    } else {
      this.pause();   // reached end
    }
  },

  // ‚îÄ‚îÄ stop: pause + go to start ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  stop(){
    this.pause();
    this.cursor = 0;
    this.draw();
    this.syncUI();
    document.getElementById('rpl-stop-btn').disabled = true;
  },

  // ‚îÄ‚îÄ reset: pause + rewind ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  reset(){
    this.pause();
    this.cursor = 0;
    this.draw();
    this.syncUI();
  },

  // ‚îÄ‚îÄ seek by fraction 0-1 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  seek(frac){
    if (!this.candles.length) return;
    this.cursor = Math.round(frac * this.candles.length);
    this.cursor = Math.max(0, Math.min(this.cursor, this.candles.length));
    this.draw();
    this.syncUI();
  },

  // ‚îÄ‚îÄ sync progress bar / time label / counters ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  syncUI(){
    const total = this.candles.length;
    const cur   = this.cursor;
    document.getElementById('rpl-candle-label').textContent = cur + ' / ' + total;
    document.getElementById('rpl-progress-bar').style.width = (total ? cur/total*100 : 0) + '%';
    const last = cur > 0 ? this.candles[cur - 1] : null;
    document.getElementById('rpl-time-label').textContent = last ? last.date.slice(11,16) : '--:--';
    document.getElementById('rpl-play-btn').disabled  = total === 0;
    document.getElementById('rpl-reset-btn').disabled = total === 0;
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // DRAW ‚Äî 3-panel chart matching the main chart image
  // Panel ratios: Price 60% | Excess Vol 25% | VWAP Dev 15%
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  draw(){
    const cv=this.cv(), ctx=this.ctx();
    const W=cv.width, H=cv.height;
    if(!W||!H) return;

    const total  =this.candles.length;
    const visible=this.candles.slice(0,this.cursor);

    // ‚îÄ‚îÄ background ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ctx.fillStyle='#0d1117'; ctx.fillRect(0,0,W,H);

    // ‚îÄ‚îÄ layout constants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const PL=68, PR=62, PT=30, PB=28;   // PR wide for right-side ORB labels
    const innerH = H - PT - PB;
    const pH = Math.floor(innerH*0.60);
    const vH = Math.floor(innerH*0.25);
    const dH = innerH - pH - vH;
    const pT=PT, vT=PT+pH+1, dT=vT+vH+1;
    const chartW=W-PL-PR;

    // ‚îÄ‚îÄ panel border lines ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ctx.strokeStyle='#21262d'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(0,vT-1); ctx.lineTo(W,vT-1); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(0,dT-1); ctx.lineTo(W,dT-1); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(0,dT+dH+PB-1); ctx.lineTo(W,dT+dH+PB-1); ctx.stroke();

    // ‚îÄ‚îÄ panel Y-axis labels ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ctx.fillStyle='#556070'; ctx.font='8px Segoe UI,sans-serif'; ctx.textAlign='left';
    ctx.fillText('PRICE & VWAP', PL+4, pT+11);
    ctx.fillText('EXCESS VOL',   PL+4, vT+11);
    ctx.fillText('VWAP DEV %',   PL+4, dT+11);

    // ‚îÄ‚îÄ empty state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(!visible.length){
      ctx.fillStyle='#8b949e'; ctx.font='14px Segoe UI,sans-serif'; ctx.textAlign='center';
      ctx.fillText(total?('‚ñ∂ Play ‚Äî '+total+' candles ready'):'üì• Load Data to begin', W/2, H/2);
      ctx.textAlign='left';
      if(total) this._timeAxis(ctx,W,PL,PR,pT,dT+dH,total,null,0,total);
      return;
    }

    // ‚îÄ‚îÄ zoom window ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // zoomStart/zoomEnd are candle indices; 0/0 = full session
    const zS = this.zoomStart;
    const zE = this.zoomEnd || total;          // exclusive end
    const zLen = Math.max(1, zE - zS);         // bars in view

    // ‚îÄ‚îÄ shared X mapping (maps candle index ‚Üí canvas X) ‚îÄ‚îÄ
    // Only candles in [zS, zE) are plotted; others are off-screen.
    const slotW  = chartW / zLen;
    const candleW= Math.max(1.5, slotW * 0.72);
    const hw     = candleW / 2;
    const toX    = i => PL + (i - zS + 0.5) * slotW;

    // ‚îÄ‚îÄ visible slice (only candles in zoom window) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // We still draw the full `visible` array but toX will put
    // out-of-window bars off-screen; clip prevents them leaking.
    // The price Y range is computed only from in-window bars.
    const winVisible = visible.slice(zS, Math.min(zE, visible.length));

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PANEL 1 ‚Äî PRICE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let hi=-Infinity,lo=Infinity;
    const priceSource = winVisible.length ? winVisible : visible;
    for(const c of priceSource){if(c.high>hi)hi=c.high; if(c.low<lo)lo=c.low;}
    const pRange=hi-lo||hi*0.01||1;
    const pPad=pRange*0.10;
    const pMin=lo-pPad, pMax=hi+pPad;
    const toY=v=>pT+(1-(v-pMin)/(pMax-pMin))*pH;

    // price grid lines
    ctx.font='9px Segoe UI,sans-serif'; ctx.fillStyle='#8b949e'; ctx.textAlign='right';
    for(let i=0;i<=5;i++){
      const f=i/5, yp=pT+f*pH, yv=pMax-f*(pMax-pMin);
      ctx.strokeStyle='#1c2128'; ctx.lineWidth=0.6;
      ctx.beginPath(); ctx.moveTo(PL,yp); ctx.lineTo(W-PR,yp); ctx.stroke();
      ctx.fillText(yv.toFixed(2),PL-3,yp+3);
    }
    ctx.textAlign='left';

    // ORB horizontal levels (dotted, coloured like main chart)
    const orbBar=visible.find(c=>c.fib0!=null);
    if(orbBar){
      const orbs=[
        {v:orbBar.fib0,  col:'#26a641',lbl:'ORB 0%'},
        {v:orbBar.fib50, col:'#58a6ff',lbl:'ORB 50%'},
        {v:orbBar.fib100,col:'#f85149',lbl:'ORB 100%'},
      ];
      orbs.forEach(({v,col,lbl})=>{
        if(v==null)return;
        const yp=toY(v);
        if(yp<pT||yp>pT+pH)return;
        ctx.strokeStyle=col; ctx.lineWidth=0.8; ctx.setLineDash([3,5]);
        ctx.beginPath(); ctx.moveTo(PL,yp); ctx.lineTo(W-PR,yp); ctx.stroke();
        ctx.setLineDash([]);
        // right-side label box (matching main chart style)
        ctx.font='8px Segoe UI,sans-serif'; ctx.fillStyle=col;
        ctx.fillText(lbl, W-PR+4, yp-2);
        ctx.fillStyle='#c9d1d9'; ctx.font='bold 8px Segoe UI,sans-serif';
        ctx.fillText(v.toFixed(1), W-PR+4, yp+8);
      });
    }

    // VWAP line ‚Äî recompute cumulative from full visible (not just window) for accuracy
    // but only draw candles in the zoom window
    {
      // build vwap for all visible bars first
      const vwapArr=[]; let cpv=0,cv2=0;
      visible.forEach(c=>{
        let v=c.vwap;
        if(v==null){const h3=(c.high+c.low+c.close)/3;cpv+=h3*c.volume;cv2+=c.volume;v=cv2?cpv/cv2:h3;}
        vwapArr.push(v);
      });
      ctx.beginPath(); ctx.strokeStyle='#58a6ff'; ctx.lineWidth=1.8; let vs=false;
      winVisible.forEach((c,wi)=>{
        const i=zS+wi, yp=toY(vwapArr[i]), xp=toX(i);
        vs?ctx.lineTo(xp,yp):(ctx.moveTo(xp,yp),vs=true);
      });
      ctx.stroke();
    }

    // Gravity ‚Äî dashed white/light
    let gS=false;
    ctx.beginPath(); ctx.strokeStyle='rgba(210,210,210,0.7)'; ctx.lineWidth=1.1; ctx.setLineDash([5,4]);
    winVisible.forEach((c,wi)=>{
      if(c.gravity==null)return;
      const xp=toX(zS+wi),yp=toY(c.gravity);
      gS?(ctx.lineTo(xp,yp)):(ctx.moveTo(xp,yp),gS=true);
    });
    ctx.stroke(); ctx.setLineDash([]);

    // Candles
    winVisible.forEach((c,wi)=>{
      const xc=toX(zS+wi),bull=c.close>=c.open,col=bull?'#26a641':'#f85149';
      const yO=toY(c.open),yC=toY(c.close),yH=toY(c.high),yL=toY(c.low);
      ctx.strokeStyle=col; ctx.lineWidth=Math.max(0.8,candleW*0.15);
      ctx.beginPath(); ctx.moveTo(xc,yH); ctx.lineTo(xc,yL); ctx.stroke();
      ctx.fillStyle=col;
      ctx.fillRect(xc-hw,Math.min(yO,yC),candleW,Math.max(1,Math.abs(yC-yO)));
    });

    // Current price dashed line + label
    const last=visible[visible.length-1];
    const lastY=toY(last.close),bull=last.close>=last.open,pcol=bull?'#26a641':'#f85149';
    ctx.strokeStyle=pcol; ctx.lineWidth=0.8; ctx.setLineDash([4,3]);
    ctx.beginPath(); ctx.moveTo(PL,lastY); ctx.lineTo(W-PR,lastY); ctx.stroke();
    ctx.setLineDash([]);
    // price label box on right
    const priceLblW=46, priceLblH=14;
    ctx.fillStyle=pcol;
    ctx.fillRect(W-PR+2, lastY-priceLblH/2, priceLblW, priceLblH);
    ctx.fillStyle='#ffffff'; ctx.font='bold 9px Segoe UI,sans-serif'; ctx.textAlign='left';
    ctx.fillText(last.close.toFixed(2), W-PR+5, lastY+4);
    ctx.textAlign='right';

    // ‚îÄ‚îÄ Signal markers on price panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const SIG=Math.max(5,candleW*2.0);
    winVisible.forEach((c,wi)=>{
      const xc=toX(zS+wi);
      // buy markers below candle
      const buyY=toY(c.low)+SIG+2;
      if(c.vol_buy_signal){
        _drawMarker(ctx,xc,buyY,'‚ñ≤','#00e5ff',SIG*2.2,'bold');
        if(c.percent_diff!=null) _drawLabel(ctx,xc,buyY+SIG+4,'+'+c.percent_diff.toFixed(0)+'%','#00e5ff','#0d1117');
      } else if(c.signal_r2g) {
        _drawMarker(ctx,xc,buyY,'‚ñ≤','#26a641',SIG*2,'bold');
      } else if(c.parabolic_rise) {
        _drawMarker(ctx,xc,buyY,'‚ñ≤','#ffd700',SIG*1.8,'bold');
      } else if(c.explosive_rise) {
        _drawMarker(ctx,xc,buyY,'‚ñ≤','#00e5ff',SIG*1.6,'');
      } else if(c.confirmed_rise) {
        _drawMarker(ctx,xc,buyY,'‚ñ≤','#26a641',SIG*1.4,'');
      } else if(c.basic_rise) {
        _drawMarker(ctx,xc,buyY,'‚ñ≤','#b3f5b3',SIG*1.2,'');
      } else if(c.escape) {
        _drawMarker(ctx,xc,buyY,'‚óÜ','#d2a8ff',SIG*1.4,'bold');
      }
      // sell markers above candle
      const sellY=toY(c.high)-SIG-2;
      if(c.vol_sell_signal){
        _drawMarker(ctx,xc,sellY,'‚ñº','#ff9f00',SIG*2.2,'bold');
        if(c.percent_diff!=null) _drawLabel(ctx,xc,sellY-SIG-4,c.percent_diff.toFixed(0)+'%','#ff9f00','#0d1117');
      } else if(c.signal_g2r) {
        _drawMarker(ctx,xc,sellY,'‚ñº','#f85149',SIG*2,'bold');
      } else if(c.crash_risk) {
        _drawMarker(ctx,xc,sellY,'‚ñº','#ff7b72',SIG*1.8,'bold');
      } else if(c.major_fall) {
        _drawMarker(ctx,xc,sellY,'‚ñº','#ffa657',SIG*1.6,'');
      }
    });

    // ‚îÄ‚îÄ Legend (top-left of price panel, matching main chart) ‚îÄ
    this._legend(ctx, PL+4, pT+4);

    // ‚îÄ‚îÄ Title ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ctx.fillStyle='#c9d1d9'; ctx.font='bold 11px Segoe UI,sans-serif'; ctx.textAlign='center';
    const dateStr=visible[0].date.slice(0,10).split('-').reverse().join(' ').replace(/(\d+) (\d+) (\d+)/,(_,d,m,y)=>{
      const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      return d+' '+months[parseInt(m)-1]+' '+y;
    });
    ctx.fillText('NSE ¬∑ '+this._ticker+' ¬∑ '+dateStr+' ¬∑ 09:15‚Äì15:30 IST ¬∑ 1-Min', W/2, pT-8);
    ctx.textAlign='left';

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PANEL 2 ‚Äî EXCESS COMBINED VOLUME
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const cvVals =winVisible.map(c=>c.combined_volume??0);
    const smVals =winVisible.map(c=>c.smoothed_volume??null);
    const allVol =[...cvVals, ...smVals.filter(v=>v!=null)];
    const vAbsMax=Math.max(...allVol.map(Math.abs),1);
    const vYMin=-vAbsMax*1.12, vYMax=vAbsMax*1.12;
    const toVY=v=>vT+(1-(v-vYMin)/(vYMax-vYMin))*vH;
    const vZero=toVY(0);

    // vol grid
    ctx.font='8px Segoe UI,sans-serif'; ctx.fillStyle='#8b949e'; ctx.textAlign='right';
    [-1,-0.5,0,0.5,1].forEach(f=>{
      const yv=vAbsMax*f, yp=toVY(yv);
      if(yp<vT||yp>vT+vH)return;
      ctx.strokeStyle='#1c2128'; ctx.lineWidth=0.5;
      ctx.beginPath(); ctx.moveTo(PL,yp); ctx.lineTo(W-PR,yp); ctx.stroke();
      const label=Math.abs(yv)>=1000?(yv/1000).toFixed(0)+'k':yv.toFixed(0);
      ctx.fillText(label,PL-3,yp+3);
    });
    ctx.textAlign='left';

    // zero line
    ctx.strokeStyle='#8b949e'; ctx.lineWidth=0.8;
    ctx.beginPath(); ctx.moveTo(PL,vZero); ctx.lineTo(W-PR,vZero); ctx.stroke();

    // no fill ‚Äî lines only

    // combined vol line ‚Äî GREEN
    ctx.beginPath(); ctx.strokeStyle='#26a641'; ctx.lineWidth=1.2;
    winVisible.forEach((c,wi)=>{ const xp=toX(zS+wi),yp=toVY(c.combined_volume??0); wi===0?ctx.moveTo(xp,yp):ctx.lineTo(xp,yp); });
    ctx.stroke();

    // smoothed vol line ‚Äî RED
    let smS=false;
    ctx.beginPath(); ctx.strokeStyle='#f85149'; ctx.lineWidth=1.8;
    winVisible.forEach((c,wi)=>{
      const v=c.smoothed_volume; if(v==null)return;
      const xp=toX(zS+wi),yp=toVY(v);
      smS?ctx.lineTo(xp,yp):(ctx.moveTo(xp,yp),smS=true);
    });
    ctx.stroke();

    // vol buy/sell markers on excess panel ‚Äî include time, pct, close price
    winVisible.forEach((c,wi)=>{
      const i=zS+wi;
      const xc=toX(i), yp=toVY(c.combined_volume??0);
      if(c.vol_buy_signal){
        _drawMarker(ctx,xc,yp-10,'‚ñ≤','#26a641',11,'bold');
        const lbl=c.date.slice(11,16)
          +(c.percent_diff!=null?' +'+c.percent_diff.toFixed(0)+'%':'')
          +' ‚Çπ'+c.close.toFixed(1);
        _drawLabel(ctx,xc,yp-24,lbl,'#26a641','#0d1117');
      }
      if(c.vol_sell_signal){
        _drawMarker(ctx,xc,yp+10,'‚ñº','#f85149',11,'bold');
        const lbl=c.date.slice(11,16)
          +(c.percent_diff!=null?' '+c.percent_diff.toFixed(0)+'%':'')
          +' ‚Çπ'+c.close.toFixed(1);
        _drawLabel(ctx,xc,yp+24,lbl,'#f85149','#0d1117');
      }
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PANEL 3 ‚Äî VWAP DEV %
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const devVals=winVisible.map(c=>c.vwap_dev??null).filter(v=>v!=null);
    let dAbsMax=Math.max(...devVals.map(Math.abs),0.1);
    const dYMin=-dAbsMax*1.2, dYMax=dAbsMax*1.2;
    const toDY=v=>dT+(1-(v-dYMin)/(dYMax-dYMin))*dH;
    const dZero=toDY(0);

    // dev grid
    ctx.font='8px Segoe UI,sans-serif'; ctx.fillStyle='#8b949e'; ctx.textAlign='right';
    [-1,-0.5,0,0.5,1].forEach(f=>{
      const yv=dAbsMax*f, yp=toDY(yv);
      if(yp<dT||yp>dT+dH)return;
      ctx.strokeStyle='#1c2128'; ctx.lineWidth=0.5;
      ctx.beginPath(); ctx.moveTo(PL,yp); ctx.lineTo(W-PR,yp); ctx.stroke();
      ctx.fillText(yv.toFixed(2)+'%',PL-3,yp+3);
    });
    ctx.textAlign='left';

    // zero line
    ctx.strokeStyle='#8b949e'; ctx.lineWidth=0.8;
    ctx.beginPath(); ctx.moveTo(PL,dZero); ctx.lineTo(W-PR,dZero); ctx.stroke();

    // fill
    ctx.save();
    const devBars=winVisible.map((c,wi)=>({c,i:zS+wi})).filter(({c})=>c.vwap_dev!=null);
    if(devBars.length){
      ctx.beginPath();
      ctx.moveTo(toX(devBars[0].i),dZero);
      devBars.forEach(({c,i})=>ctx.lineTo(toX(i),toDY(c.vwap_dev)));
      ctx.lineTo(toX(devBars[devBars.length-1].i),dZero);
      ctx.closePath(); ctx.clip();
      ctx.fillStyle='rgba(38,166,65,0.40)';  ctx.fillRect(PL,dT,chartW,Math.max(0,dZero-dT));
      ctx.fillStyle='rgba(248,81,73,0.40)';  ctx.fillRect(PL,dZero,chartW,dH);
    }
    ctx.restore();

    // dev line
    let dvS=false;
    ctx.beginPath(); ctx.strokeStyle='#58a6ff'; ctx.lineWidth=1.2;
    winVisible.forEach((c,wi)=>{
      if(c.vwap_dev==null)return;
      const xp=toX(zS+wi),yp=toDY(c.vwap_dev);
      dvS?ctx.lineTo(xp,yp):(ctx.moveTo(xp,yp),dvS=true);
    });
    ctx.stroke();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SHARED TIME AXIS ‚Äî dotted verticals spanning all panels
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    this._timeAxis(ctx,W,PL,PR,pT,dT+dH,total,toX,zS,zE);

    // ‚îÄ‚îÄ Info bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const b2=last.close>=last.open;
    const sigs=[];
    if(last.vol_buy_signal)  sigs.push('<span style="color:#00e5ff;font-weight:700">VolBUY'+(last.percent_diff!=null?' +'+last.percent_diff.toFixed(0)+'%':'')+'</span>');
    if(last.vol_sell_signal) sigs.push('<span style="color:#ff9f00;font-weight:700">VolSELL'+(last.percent_diff!=null?' '+last.percent_diff.toFixed(0)+'%':'')+'</span>');
    if(last.signal_r2g)      sigs.push('<span style="color:#26a641;font-weight:700">R‚ÜíG</span>');
    if(last.signal_g2r)      sigs.push('<span style="color:#f85149;font-weight:700">G‚ÜíR</span>');
    if(last.parabolic_rise)  sigs.push('<span style="color:#ffd700">Parabolic</span>');
    if(last.explosive_rise)  sigs.push('<span style="color:#00e5ff">Explosive</span>');
    if(last.confirmed_rise)  sigs.push('<span style="color:#3fb950">Confirmed</span>');
    if(last.crash_risk)      sigs.push('<span style="color:#ff7b72">Crash‚ö†</span>');
    if(last.major_fall)      sigs.push('<span style="color:#ffa657">MajFall</span>');
    if(last.escape)          sigs.push('<span style="color:#d2a8ff">Escape</span>');
    document.getElementById('rpl-ohlcv').innerHTML=
      'O <b style="color:'+(b2?'#26a641':'#f85149')+'">'+last.open.toFixed(2)+'</b>  '+
      'H <b style="color:#26a641">'+last.high.toFixed(2)+'</b>  '+
      'L <b style="color:#f85149">'+last.low.toFixed(2)+'</b>  '+
      'C <b style="color:'+(b2?'#26a641':'#f85149')+'">'+last.close.toFixed(2)+'</b>  '+
      'Vol <b style="color:#ffa657">'+(last.volume/1e6).toFixed(2)+'M</b>'+
      (sigs.length?'  &nbsp;'+sigs.join(' &nbsp;'):'');
  },

  // ‚îÄ‚îÄ Legend box in top-left of price panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  _legend(ctx, x, y){
    const items=[
      {col:'#58a6ff', lw:2,   ls:null,  lbl:'VWAP'},
      {col:'#d0d0d0', lw:1.1, ls:[4,3], lbl:'Gravity'},
      {col:'#26a641', lw:1,   ls:[3,4], lbl:'ORB 0%'},
      {col:'#58a6ff', lw:1,   ls:[3,4], lbl:'ORB 50%'},
      {col:'#f85149', lw:1,   ls:[3,4], lbl:'ORB 100%'},
      {mrk:'‚ñº', col:'#f85149', lbl:'G‚ÜíR Flip'},
      {mrk:'‚ñ≤', col:'#26a641', lbl:'R‚ÜíG Flip'},
      {mrk:'‚ñ≤', col:'#00e5ff', lbl:'Vol Buy ‚â•+25%'},
      {mrk:'‚ñº', col:'#ff9f00', lbl:'Vol Sell ‚â§-25%'},
      {mrk:'‚óÜ', col:'#ff00ff', lbl:'Vol Surge'},
    ];
    const cols=2, rows=Math.ceil(items.length/cols);
    const itemW=110, itemH=13;
    const boxW=cols*itemW+8, boxH=rows*itemH+8;
    ctx.fillStyle='rgba(22,27,34,0.85)';
    ctx.strokeStyle='#30363d'; ctx.lineWidth=0.8;
    ctx.fillRect(x,y,boxW,boxH);
    ctx.strokeRect(x,y,boxW,boxH);
    items.forEach((it,idx)=>{
      const col=idx%cols, row=Math.floor(idx/cols);
      const ix=x+6+col*itemW, iy=y+6+row*itemH;
      if(it.mrk){
        ctx.fillStyle=it.col; ctx.font='bold 9px Segoe UI,sans-serif';
        ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.fillText(it.mrk,ix+5,iy+5);
      } else {
        ctx.save();
        if(it.ls) ctx.setLineDash(it.ls);
        ctx.strokeStyle=it.col; ctx.lineWidth=it.lw;
        ctx.beginPath(); ctx.moveTo(ix,iy+5); ctx.lineTo(ix+10,iy+5); ctx.stroke();
        ctx.setLineDash([]); ctx.restore();
      }
      ctx.fillStyle='#c9d1d9'; ctx.font='8px Segoe UI,sans-serif';
      ctx.textAlign='left'; ctx.textBaseline='alphabetic';
      ctx.fillText(it.lbl, ix+13, iy+9);
    });
    ctx.textAlign='left'; ctx.textBaseline='alphabetic';
  },

  // ‚îÄ‚îÄ Time axis: dotted vertical lines spanning all panels ‚îÄ
  _timeAxis(ctx,W,PL,PR,panelTop,panelBot,total,toX,zS=0,zE=0){
    const MARKS=['09:15','09:30','10:00','10:30','11:00','11:30',
                 '12:00','12:30','13:00','13:30','14:00','14:30','15:00','15:30'];
    const slotW=(W-PL-PR)/total;
    ctx.font='9px Segoe UI,sans-serif'; ctx.fillStyle='#8b949e'; ctx.textAlign='center';
    const _zE = zE || total;
    MARKS.forEach(t=>{
      const idx=this.candles.findIndex(c=>c.date.slice(11,16)===t);
      if(idx>=0 && (idx<zS || idx>=_zE)) return;   // skip marks outside zoom window
      let xp;
      if(idx>=0&&toX){ xp=toX(idx); }
      else { const[hh,mm]=t.split(':').map(Number); xp=PL+(hh*60+mm-(9*60+15))*slotW+slotW*0.5; }
      if(xp<PL||xp>W-PR) return;
      ctx.strokeStyle='#21262d'; ctx.lineWidth=0.5; ctx.setLineDash([2,3]);
      ctx.beginPath(); ctx.moveTo(xp,panelTop); ctx.lineTo(xp,panelBot); ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillText(t,xp,panelBot+12);
    });
    ctx.textAlign='left';
  },

  // ‚îÄ‚îÄ Hover: show OHLCV for candle under mouse ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  onHover(mx){
    const vis=this.candles.slice(0,this.cursor);
    if(!vis.length)return;
    const slotW=(this.cv().width-68-62)/this.candles.length;
    const idx=Math.floor((mx-68)/slotW);
    if(idx<0||idx>=vis.length)return;
    const c=vis[idx],b=c.close>=c.open;
    const sigs=[];
    if(c.vol_buy_signal)  sigs.push('<span style="color:#00e5ff;font-weight:700">VolBUY'+(c.percent_diff!=null?' +'+c.percent_diff.toFixed(0)+'%':'')+'</span>');
    if(c.vol_sell_signal) sigs.push('<span style="color:#ff9f00;font-weight:700">VolSELL'+(c.percent_diff!=null?' '+c.percent_diff.toFixed(0)+'%':'')+'</span>');
    if(c.signal_r2g)      sigs.push('<span style="color:#26a641">R‚ÜíG</span>');
    if(c.signal_g2r)      sigs.push('<span style="color:#f85149">G‚ÜíR</span>');
    document.getElementById('rpl-ohlcv').innerHTML=
      '<b style="color:#ffd700">'+c.date.slice(11,16)+'</b>  '+
      'O <b style="color:'+(b?'#26a641':'#f85149')+'">'+c.open.toFixed(2)+'</b>  '+
      'H <b style="color:#26a641">'+c.high.toFixed(2)+'</b>  '+
      'L <b style="color:#f85149">'+c.low.toFixed(2)+'</b>  '+
      'C <b style="color:'+(b?'#26a641':'#f85149')+'">'+c.close.toFixed(2)+'</b>  '+
      'Vol <b style="color:#ffa657">'+(c.volume/1e6).toFixed(2)+'M</b>'+
      (sigs.length?'  &nbsp;'+sigs.join(' &nbsp;'):'');
  },

  // ‚îÄ‚îÄ Zoom helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // wheelZoom: zoom in/out centered on mouse X position
  wheelZoom(deltaY, mouseX){
    if(!this.candles.length) return;
    const total=this.candles.length;
    const vis=this.cursor||total;
    const zS=this.zoomStart, zE=this.zoomEnd||vis;
    const zLen=zE-zS;

    // factor: scroll up = zoom in (shrink window), down = zoom out
    const factor = deltaY < 0 ? 0.80 : 1.25;
    const newLen  = Math.round(Math.max(10, Math.min(vis, zLen*factor)));

    // anchor: keep the bar under the mouse fixed
    const PL=68, PR=62;
    const chartW=this.cv().width-PL-PR;
    const frac=Math.max(0,Math.min(1,(mouseX-PL)/chartW));
    const anchorBar = Math.round(zS + frac*zLen);

    let newStart=Math.round(anchorBar - frac*newLen);
    let newEnd  =newStart+newLen;
    if(newStart<0){newStart=0; newEnd=newLen;}
    if(newEnd>vis){newEnd=vis; newStart=Math.max(0,vis-newLen);}

    this.zoomStart=newStart;
    this.zoomEnd  =newEnd;
    this.draw();
  },

  // pan: shift zoom window left/right by dx pixels
  panBy(dBars){
    if(!this.candles.length) return;
    const vis=this.cursor||this.candles.length;
    const zS=this.zoomStart, zE=this.zoomEnd||vis;
    const zLen=zE-zS;
    let ns=zS+dBars, ne=zE+dBars;
    if(ns<0){ns=0;ne=zLen;}
    if(ne>vis){ne=vis;ns=Math.max(0,vis-zLen);}
    this.zoomStart=ns; this.zoomEnd=ne;
    this.draw();
  },

  // reset zoom to full view
  resetZoom(){
    this.zoomStart=0; this.zoomEnd=0; this.draw();
  },
};

// ‚îÄ‚îÄ Marker drawing helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _drawMarker(ctx, x, y, char, color, size, weight) {
  ctx.save();
  ctx.fillStyle=color;
  ctx.font=(weight?weight+' ':'')+Math.round(size)+'px Segoe UI,sans-serif';
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText(char,x,y);
  ctx.restore();
}

// ‚îÄ‚îÄ Label with background box ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _drawLabel(ctx, x, y, text, textCol, bgCol) {
  ctx.save();
  ctx.font='bold 7px Segoe UI,sans-serif';
  ctx.textAlign='center'; ctx.textBaseline='middle';
  const tw=ctx.measureText(text).width;
  const pw=4, ph=3;
  ctx.fillStyle=bgCol;
  ctx.fillRect(x-tw/2-pw, y-5-ph, tw+pw*2, 10+ph*2);
  ctx.strokeStyle=textCol; ctx.lineWidth=0.6;
  ctx.strokeRect(x-tw/2-pw, y-5-ph, tw+pw*2, 10+ph*2);
  ctx.fillStyle=textCol;
  ctx.fillText(text,x,y);
  ctx.restore();
}

// ‚îÄ‚îÄ Replay button handlers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function rplLoad(){
  const btn = $('rpl-load-btn');
  btn.disabled = true;
  btn.textContent = '‚è≥ Loading‚Ä¶';
  try {
    // ensure canvas dimensions are correct before drawing
    RPL.resize();
    const n = await RPL.load(getTicker());
    btn.textContent = '‚úì ' + getTicker().replace('.NS','') + ' ‚Äî ' + n + ' bars';
    $('rpl-play-btn').disabled  = false;
    $('rpl-reset-btn').disabled = false;
  } catch(e) {
    btn.textContent = 'üì• Load Data';
    alert('Load failed: ' + e.message);
  } finally {
    btn.disabled = false;
  }
}
function rplPlayPause(){ RPL.playPause(); }
function rplStop()     { RPL.stop(); }
function rplReset()    { RPL.reset(); }

$('rpl-progress-wrap').addEventListener('click', e => {
  const rect = $('rpl-progress-wrap').getBoundingClientRect();
  RPL.seek(Math.max(0, Math.min(1, (e.clientX-rect.left)/rect.width)));
});

// ‚îÄ‚îÄ Wheel: zoom in/out centered on mouse position ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('rpl-canvas').addEventListener('wheel', e => {
  e.preventDefault();
  const rect = $('rpl-canvas').getBoundingClientRect();
  RPL.wheelZoom(e.deltaY, e.clientX - rect.left);
}, { passive: false });

// ‚îÄ‚îÄ Drag to pan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('rpl-canvas').addEventListener('mousedown', e => {
  if (e.button !== 0) return;
  const rect = $('rpl-canvas').getBoundingClientRect();
  RPL._drag = {
    startX     : e.clientX - rect.left,
    startZS    : RPL.zoomStart,
    startZE    : RPL.zoomEnd || (RPL.cursor || RPL.candles.length),
  };
  $('rpl-canvas').style.cursor = 'grabbing';
});

$('rpl-canvas').addEventListener('mousemove', e => {
  const rect = $('rpl-canvas').getBoundingClientRect();
  const mx   = e.clientX - rect.left;

  if (RPL._drag) {
    const PL=68, PR=62;
    const chartW = $('rpl-canvas').width - PL - PR;
    const zLen   = RPL._drag.startZE - RPL._drag.startZS;
    const slotW  = chartW / zLen;
    const dBars  = Math.round((RPL._drag.startX - mx) / slotW);
    const vis    = RPL.cursor || RPL.candles.length;

    let ns = RPL._drag.startZS + dBars;
    let ne = RPL._drag.startZE + dBars;
    if (ns < 0)   { ns = 0;   ne = zLen; }
    if (ne > vis) { ne = vis; ns = Math.max(0, vis - zLen); }
    RPL.zoomStart = ns;
    RPL.zoomEnd   = ne;
    RPL.draw();
  } else {
    RPL.onHover(mx);
  }
});

['mouseup','mouseleave'].forEach(ev => $('rpl-canvas').addEventListener(ev, () => {
  RPL._drag = null;
  $('rpl-canvas').style.cursor = 'crosshair';
}));

$('rpl-canvas').addEventListener('dblclick', () => RPL.resetZoom());

// ‚îÄ‚îÄ Init canvas on page load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('load', () => {
  RPL.resize();
  RPL.draw();
});
window.addEventListener('resize', () => { RPL.resize(); RPL.draw(); });

// ‚îÄ‚îÄ Init dropdown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
buildList('');
</script>
</body>
</html>
